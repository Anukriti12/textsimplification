{"ast":null,"code":"// import React, { useState, useEffect, useRef  } from \"react\";\n// import { useLocation, useNavigate } from \"react-router-dom\";\n// import DiffMatchPatch from \"diff-match-patch\";\n// import { FaRegCopy, FaDownload } from \"react-icons/fa\"; // Import FontAwesome icons\n// import { saveAs } from \"file-saver\";\n// import styles from \"./styles.module.css\";\n// const Review = () => {\n//   const { state } = useLocation();\n//   // const { inputText, outputText: initialOutputText, editHistory: restoredEditHistory } = state || {\n//   //   inputText: \"\",\n//   //   outputText: \"\",\n//   //   editHistory: [],\n//   // };\n//   const initialState = state || {\n//     inputText: \"\",\n//     outputText: \"\",\n//     editHistory: []\n//   };\n//   const [inputText, setInputText] = useState(initialState.inputText);\n//   const [outputText, setOutputText] = useState(initialOutputText);\n//   const [editHistory, setEditHistory] = useState(restoredEditHistory || []);\n//   const [saveHistory, setSaveHistory] = useState([]);\n//   const [showStats, setShowStats] = useState(false);\n//   const [diffHtml, setDiffHtml] = useState(\"\");\n//   const [isSaveButtonEnabled, setIsSaveButtonEnabled] = useState(false);\n//   const navigate = useNavigate();\n//   const [isEditable, setIsEditable] = useState(false);\n//   const [isSidebarVisible, setIsSidebarVisible] = useState(false);\n//   const [showDifference, setShowDifference] = useState(false);\n//   const [inputWordCount, setInputWordCount] = useState(0);\n//   const [inputCharCount, setInputCharCount] = useState(0);\n//   const [outputWordCount, setOutputWordCount] = useState(0);\n//   const [outputCharCount, setOutputCharCount] = useState(0);\n// //   const navigate = useNavigate();\n//   const [isHistoryVisible, setIsHistoryVisible] = useState(false); // Show/Hide history sidebar\n//   const contentEditableRef = useRef(null); // Reference to the contentEditable div\n// \tconst [isLoading, setIsLoading] = useState(false);\n// \tconst [isSaveButtonVisible, setIsSaveButtonVisible] = useState(true);\n// \tconst [showSurveyPrompt, setShowSurveyPrompt] = useState(false); // State for survey prompt\n//   const surveyRef = useRef(null);\n//   const user = JSON.parse(localStorage.getItem(\"user\"));\n//   const email = user?.email;\n//   const [documents, setDocuments] = useState([]);\n//   const [selectedDocument, setSelectedDocument] = useState(null);\n//   const [selectedVersion, setSelectedVersion] = useState(null);\n//   const [selectedVersionIndex, setSelectedVersionIndex] = useState(0); \n//   const [expandedDocs, setExpandedDocs] = useState({});\n//   const [liveEditedText, setLiveEditedText] = useState(initialOutputText);\n//   // const contentEditableRef = useRef(null);\n//   // const [outputText, setOutputText] = useState(\"\");\n//     const handleLogout = () => {\n//     localStorage.removeItem(\"token\");\n// \tnavigate(\"/Login\"); \n//   localStorage.removeItem(\"reviewPageState\"); // Clear the saved state\n//    // window.location.reload();\n//   };\n//   const countWordsAndChars = (text) => {\n//     const words = text.trim().split(/\\s+/).filter(Boolean).length;\n//     const chars = text.length;\n//     return { words, chars };\n//   };\n//       // Function to calculate and render diff\n//       const generateDiff = (input, output) => {\n//         if (!input || !output) return \"\";\n//         const dmp = new DiffMatchPatch();\n//         const diffs = dmp.diff_main(input, output);\n//         dmp.diff_cleanupSemantic(diffs);\n//         const html = diffs\n//           .map(([op, text]) => {\n//             if (op === DiffMatchPatch.DIFF_INSERT) {\n//               return `<span style=\"background-color: #d4fcdc; color: green;\">${text}</span>`;\n//             } else if (op === DiffMatchPatch.DIFF_DELETE) {\n//               return `<span style=\"background-color: #ffecec; color: red; text-decoration: line-through;\">${text}</span>`;\n//             } else {\n//               return `<span>${text}</span>`;\n//             }\n//           })\n//           .join(\"\");\n//         return html;\n//       };\n// \t// Function to format the prompt with user input\n//   // const generatePrompt = (inputText) => {\n//   //   return `\n//   //   You are an expert in accessible communication, tasked with transforming complex text into clear, accessible plain language for individuals with Intellectual and Developmental Disabilities (IDD) or those requiring simplified content. Retain all essential information and intent while prioritizing readability, comprehension, and inclusivity.\n//   //   Text simplification refers to rewriting or adapting text to make it easier to read and understand while keeping the same level of detail and precision. Make sure you focus on simplification and not summarization. The length of generated output text must be similar to that of input text.\n//   //   Guidelines for Simplification:\n//   //   Vocabulary and Terminology:\n//   //   Replace uncommon, technical, or abstract words with simple, everyday language.\n//   //   Define unavoidable complex terms in plain language within parentheses upon first use (example: â€œcardiologist (heart doctor)â€).\n//   //   Avoid idioms, metaphors, sarcasm, or culturally specific references.\n//   //   Sentence Structure:\n//   //   Use short sentences (10--15 words max). Break long sentences into 1â€“2 ideas each.\n//   //   Prefer active voice (example: â€œThe doctor examined the patientâ€ vs. â€œThe patient was examined by the doctorâ€).\n//   //   Avoid nested clauses, passive voice, and ambiguous pronouns (example: â€œthey,â€ â€œitâ€).\n//   //   Clarity and Flow:\n//   //   Organize content logically, using headings/subheadings to group related ideas.\n//   //   Use bullet points or numbered lists for steps, options, or key points.\n//   //   Ensure each paragraph focuses on one main idea.\n//   //   Tone and Engagement:\n//   //   Write in a neutral, conversational tone (avoid formal or academic language).\n//   //   Address the reader directly with â€œyouâ€ or â€œweâ€ where appropriate.\n//   //   Use consistent terms for concepts (avoid synonyms that may confuse).\n//   //   Avoid Exclusionary Elements:\n//   //   Remove jargon, acronyms (unless defined), and expand abbreviations if needed (example: â€œASAPâ€ â†’ â€œas soon as possibleâ€).\n//   //   Eliminate metaphors, idioms, or implied meanings (example: â€œhit the booksâ€ â†’ â€œstudyâ€).\n//   //   Avoid double negatives (example: â€œnot uncommonâ€ â†’ â€œcommonâ€).\n//   //   Structural Support:\n//   //   Add clear headings to label sections (example: â€œHow to Apply for Benefitsâ€).\n//   //   Use formatting tools like bold for key terms or warnings.\n//   //   Chunk information into short paragraphs with line breaks for visual ease.\n//   //   Inclusivity Checks:\n//   //   Ensure content is free of bias, stereotypes, or assumptions about the reader.\n//   //   Use gender-neutral language (example: â€œtheyâ€ instead of â€œhe/sheâ€).\n//   //   Output Requirements:\n//   //   Return only the simplified text, without markdown, emojis, or images.\n//   //   Preserve original context, facts, and intent. Do not omit critical details.\n//   //   Prioritize clarity over brevity; focus on simplification and not summarization. The length of generated output text should be same or similar to that of input text.\n//   //   Do not simplify already simple text.\n//   //   Example Transformation:\n//   //   Original: â€œIndividuals experiencing adverse climatic conditions may necessitate relocation to mitigate health risks.â€\n//   //   Simplified: â€œIf weather conditions become dangerous, people might need to move to stay safe.â€\n//   //   For the provided input text, apply the above guidelines rigorously. Ensure the output is accessible to readers with varied cognitive abilities, emphasizing clarity, simplicity, and logical structure. Verify that the simplified text aligns with plain language standards like WCAG and PlainLanguage.gov.\n//   //   \"${inputText}\"\n//   //   `;\n//   //   };\n//     // const splitTextIntoChunks = (text, maxTokens) => {\n//     // const words = text.split(\" \");\n//     // let chunks = [];\n//     // let currentChunk = [];\n//     // for (let word of words) {\n//     //   if (currentChunk.join(\" \").length + word.length < maxTokens) {\n//     //   currentChunk.push(word);\n//     //   } else {\n//     //   chunks.push(currentChunk.join(\" \"));\n//     //   currentChunk = [word];\n//     //   }\n//     // }\n//     // if (currentChunk.length > 0) chunks.push(currentChunk.join(\" \"));\n//     // return chunks;\n//     // };\n//   const saveSimplification = async () => {\n//     try {\n//       const user = JSON.parse(localStorage.getItem(\"user\"));\n//       if (!user) return;\n//     const numWordsInput = inputText.trim().split(/\\s+/).filter(Boolean).length;\n//     const numCharsInput = inputText.length;\n//     const numWordsOutput = outputText.trim().split(/\\s+/).filter(Boolean).length;\n//     const numCharsOutput = outputText.length;\n//       const response = await fetch(\"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/simplifications\", {\n//         method: \"POST\",\n//         headers: { \"Content-Type\": \"application/json\" },\n//         body: JSON.stringify({\n//           userId: user._id,\n//           inputText,\n//           outputText,\n//           metrics: { numWordsInput, numCharsInput, numWordsOutput, numCharsOutput }\n//         }),\n//       });\n//       if (response.ok) {\n//         console.log(\"Simplification saved successfully.\");\n//       } else {\n//         const error = await response.json();\n//         console.error(\"Error saving simplification:\", error.message);\n//       }\n//     } catch (error) {\n//       console.error(\"Error saving simplification:\", error);\n//     }\n//   };\n//   // const handleResimplify = async () => {\n//   //   if (!inputText.trim()) return;\n//   //   setIsLoading(true); // Show loading state\n//   //   try {\n//   //     const chunks = splitTextIntoChunks(inputText, 10000);\n//   //     let combinedOutput = \"\";\n//   //     for (let chunk of chunks) {\n//   //     const prompt = generatePrompt(chunk);\n//   //     const response = await fetch(\"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/gpt4\", {\n//   //       method: \"POST\",\n//   //       headers: { \"Content-Type\": \"application/json\" },\n//   //       body: JSON.stringify({ prompt }),\n//   //     });\n//   //     if (!response.ok) {\n//   //       console.error(\"Error with API request:\", response.status);\n//   //       return;\n//   //     }\n//   //     const data = await response.json();\n//   //     console.log(\"Full API Response: \", data);\n//   //     const newOutput = data?.response?.replace(/^\"|\"$/g, \"\") || \"No response received.\";\n//   //     // Update System-generated Text\n//   //     combinedOutput += newOutput + \" \";\n//   //     console.log(\"Final Combined Output: \", combinedOutput);\n//   //     }\n//   //     setOutputText(combinedOutput);\n//   //   } catch (error) {\n//   //     console.error(\"Error fetching GPT-4o response:\", error);\n//   //     setOutputText(\"An error occurred while simplifying the text.\");\n//   //   }\n//   //   setIsLoading(false);\n//   // };\n//     // Handle re-simplify request\n//     const handleResimplify = async () => {\n//       if (!inputText.trim()) return;\n//       setIsLoading(true);\n//       try {\n//         const generatePrompt = (text) => `\n//     You are an expert in accessible communication, tasked with transforming complex text into clear, accessible plain language for individuals with Intellectual and Developmental Disabilities (IDD) or those requiring simplified content. Retain all essential information and intent while prioritizing readability, comprehension, and inclusivity.\n//     Text simplification refers to rewriting or adapting text to make it easier to read and understand while keeping the same level of detail and precision. Make sure you focus on simplification and not summarization. The length of generated output text must be similar to that of input text.\n//     Guidelines for Simplification:\n//     Vocabulary and Terminology:\n//     Replace uncommon, technical, or abstract words with simple, everyday language.\n//     Define unavoidable complex terms in plain language within parentheses upon first use (example: â€œcardiologist (heart doctor)â€).\n//     Avoid idioms, metaphors, sarcasm, or culturally specific references.\n//     Sentence Structure:\n//     Use short sentences (10--15 words max). Break long sentences into 1â€“2 ideas each.\n//     Prefer active voice (example: â€œThe doctor examined the patientâ€ vs. â€œThe patient was examined by the doctorâ€).\n//     Avoid nested clauses, passive voice, and ambiguous pronouns (example: â€œthey,â€ â€œitâ€).\n//     Clarity and Flow:\n//     Organize content logically, using headings/subheadings to group related ideas.\n//     Use bullet points or numbered lists for steps, options, or key points.\n//     Ensure each paragraph focuses on one main idea.\n//     Tone and Engagement:\n//     Write in a neutral, conversational tone (avoid formal or academic language).\n//     Address the reader directly with â€œyouâ€ or â€œweâ€ where appropriate.\n//     Use consistent terms for concepts (avoid synonyms that may confuse).\n//     Avoid Exclusionary Elements:\n//     Remove jargon, acronyms (unless defined), and expand abbreviations if needed (example: â€œASAPâ€ â†’ â€œas soon as possibleâ€).\n//     Eliminate metaphors, idioms, or implied meanings (example: â€œhit the booksâ€ â†’ â€œstudyâ€).\n//     Avoid double negatives (example: â€œnot uncommonâ€ â†’ â€œcommonâ€).\n//     Structural Support:\n//     Add clear headings to label sections (example: â€œHow to Apply for Benefitsâ€).\n//     Use formatting tools like bold for key terms or warnings.\n//     Chunk information into short paragraphs with line breaks for visual ease.\n//     Inclusivity Checks:\n//     Ensure content is free of bias, stereotypes, or assumptions about the reader.\n//     Use gender-neutral language (example: â€œtheyâ€ instead of â€œhe/sheâ€).\n//     Output Requirements:\n//     Return only the simplified text, without markdown, emojis, or images.\n//     Preserve original context, facts, and intent. Do not omit critical details.\n//     Prioritize clarity over brevity; focus on simplification and not summarization. The length of generated output text should be same or similar to that of input text.\n//     Do not simplify already simple text.\n//     Example Transformation:\n//     Original: â€œIndividuals experiencing adverse climatic conditions may necessitate relocation to mitigate health risks.â€\n//     Simplified: â€œIf weather conditions become dangerous, people might need to move to stay safe.â€\n//     For the provided input text, apply the above guidelines rigorously. Ensure the output is accessible to readers with varied cognitive abilities, emphasizing clarity, simplicity, and logical structure. Verify that the simplified text aligns with plain language standards like WCAG and PlainLanguage.gov.\n//           \"${text}\"`;\n//         const splitTextIntoChunks = (text, maxTokens) => {\n//           const words = text.split(/\\s+/);\n//           let chunks = [];\n//           let currentChunk = [];\n//           for (let word of words) {\n//             if (currentChunk.join(\" \").length + word.length < maxTokens) {\n//               currentChunk.push(word);\n//             } else {\n//               chunks.push(currentChunk.join(\" \"));\n//               currentChunk = [word];\n//             }\n//           }\n//           if (currentChunk.length > 0) chunks.push(currentChunk.join(\" \"));\n//           return chunks;\n//         };\n//         const chunks = splitTextIntoChunks(inputText, 10000);\n//         let combinedOutput = \"\";\n//         for (let chunk of chunks) {\n//           const prompt = generatePrompt(chunk);\n//           const response = await fetch(\"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/gpt4\", {\n//             method: \"POST\",\n//             headers: { \"Content-Type\": \"application/json\" },\n//             body: JSON.stringify({ prompt }),\n//           });\n//           if (!response.ok) {\n//             console.error(\"Error with API request:\", response.status);\n//             continue; // Skip this chunk if the API request failed\n//           }\n//           const data = await response.json();\n//           const newOutput = data?.response?.replace(/^\"|\"$/g, \"\") || \"No response received.\";\n//           combinedOutput += newOutput + \" \";\n//         }\n//         setOutputText(combinedOutput.trim());\n//         // Update diff when output text changes\n//         const diffResult = generateDiff(inputText, combinedOutput.trim());\n//         setDiffHtml(diffResult);\n//         setIsSaveButtonEnabled(true);\n//       } catch (error) {\n//         console.error(\"Error fetching GPT-4o response:\", error);\n//         alert(\"An error occurred while simplifying the text. Please try again.\");\n//       }\n//       setIsLoading(false);\n//     };\n//   //\n//   const saveEditToHistory = async (editedText) => {\n//     try {\n//       const user = JSON.parse(localStorage.getItem(\"user\"));\n//       if (!user) return;\n//       const numWords = editedText.trim().split(/\\s+/).filter(Boolean).length;\n//       const numChars = editedText.length;\n//       const response = await fetch(\"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/simplifications/edit\", {\n//         method: \"PUT\",\n//         headers: { \"Content-Type\": \"application/json\" },\n//         body: JSON.stringify({\n//           email: user.email,\n//           inputText: selectedDocument?.inputText || inputText,\n//           // inputText,\n//           editedText,\n//           numWords,\n//           numChars\n//         }),\n//       });\n//       if (response.ok) {\n//         console.log(\"Edit saved to history.\");\n//         fetchDocumentHistory();\n//       } else {\n//         const error = await response.json();\n//         console.error(\"Error saving edit to history:\", error.message);\n//       }\n//     } catch (error) {\n//       console.error(\"Error saving edit to history:\", error);\n//     }\n//   };\n//   const saveFinalOutput = async () => {\n//     // const finalText = contentEditableRef.current?.innerText || \"\";\n//     // console.log(\"Final text to submit:\", finalText);\n//     // setOutputText(finalText);\n//     setIsLoading(true);\n//     try {\n//       const user = JSON.parse(localStorage.getItem(\"user\"));\n//       if (!user) return;\n//       const numWords = outputText.trim().split(/\\s+/).filter(Boolean).length;\n//       const numChars = outputText.length;\n//       const finalText = document.getElementById(\"outputText\")?.value || outputText;\n//       const response = await fetch(\"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/simplifications/save\", {\n//         method: \"PUT\",\n//         headers: { \"Content-Type\": \"application/json\" },\n//         body: JSON.stringify({\n//           email: user.email,\n//           // inputText,\n//           inputText: selectedDocument?.inputText || inputText,\n//           finalText: outputText,\n//           numWords,\n//           numChars,\n//           readability: 4, // Example value, replace with user input\n//           accuracy: 5, // Example value, replace with user input\n//           comments: \"Looks good.\" // Example value, replace with user input\n//         }),\n//       });\n//     const timestamp = new Date().toISOString();\n//     setEditHistory((prev) => [\n//       ...prev,\n//       { timestamp, text: finalText},\n//     ]);\n//       if (response.ok) {\n//         console.log(\"Final output saved successfully.\");\n//         setIsSaveButtonEnabled(false); // Disable save button\n//         setShowSurveyPrompt(true);    // Ensure survey prompt is displayed\n//         // âœ… Automatically scroll to survey prompt\n//         setTimeout(() => {\n//             if (surveyRef.current) {\n//                 surveyRef.current.scrollIntoView({ behavior: \"smooth\", block: \"center\" });\n//             }\n//         }, 300);\n//         const timestamp = new Date().toISOString();\n//         setSaveHistory((prev) => [...prev, { timestamp, finalText: finalText}]); // ðŸ”¹ Save to history\n//         fetchDocumentHistory();\n//       } else {\n//         const error = await response.json();\n//         console.error(\"Error saving final output:\", error.message);\n//       }\n//     } catch (error) {\n//       console.error(\"Error saving final output:\", error);\n//     } finally {\n//       setIsLoading(false);\n//     }\n//   };\n//   const handleEditChange = (event) => {\n//     const updatedText = event.target.value;\n//     setOutputText(updatedText);\n//     setIsSaveButtonEnabled(true); // Enable save button on edit\n//     // Update diff when output text changes\n//     const diffResult = generateDiff(selectedDocument?.inputText || inputText, updatedText);\n//     setDiffHtml(diffResult);\n//     // Save the change to edit history in MongoDB after a delay (debouncing)\n//     const timeoutId = setTimeout(() => {\n//       saveEditToHistory(updatedText);\n//     }, 2000); // 2 second delay\n//     return () => clearTimeout(timeoutId);\n//     // Save the change to edit history in MongoDB\n//     // saveEditToHistory(updatedText);\n//   };\n//   const handleCopy = (text) => {\n//     navigator.clipboard.writeText(text).then(\n//       () => {\n//         alert(\"Copied to clipboard!\");\n//       },\n//       (err) => {\n//         console.error(\"Failed to copy text:\", err);\n//       }\n//     );\n//   };\n//   const handleDownload = (text, filename, format) => {\n//     const blob = new Blob([text], { type: \"text/plain;charset=utf-8\" });\n//     saveAs(blob, `${filename}.${format}`);\n//   };\n//   // Fetch document history from database\n//   const fetchDocumentHistory = async () => {\n//     try {\n//       if (!email) return;\n//       const response = await fetch(\n//         `https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/simplifications/user/${email}`\n//       );\n//       if (!response.ok) {\n//         throw new Error(`HTTP error! status: ${response.status}`);\n//       }\n//       const result = await response.json();\n//       if (result.data) {\n//         // Group documents by inputText to avoid duplicates\n//         const uniqueDocuments = [];\n//         const inputTextMap = new Map();\n//         result.data.forEach(doc => {\n//           // Use inputText as the key for grouping\n//           if (!inputTextMap.has(doc.inputText)) {\n//             inputTextMap.set(doc.inputText, doc);\n//             uniqueDocuments.push(doc);\n//           } else {\n//             // If we already have this inputText, merge the save history\n//             const existingDoc = inputTextMap.get(doc.inputText);\n//             // Merge edit history if it exists\n//             if (doc.editHistory && doc.editHistory.length > 0) {\n//               existingDoc.editHistory = [...(existingDoc.editHistory || []), ...doc.editHistory];\n//             }\n//             // Merge save history if it exists\n//             if (doc.saveHistory && doc.saveHistory.length > 0) {\n//               existingDoc.saveHistory = [...(existingDoc.saveHistory || []), ...doc.saveHistory];\n//             }\n//             // Update the map with the merged document\n//             inputTextMap.set(doc.inputText, existingDoc);\n//           }\n//         });\n//   // useEffect(() => {\n//   //   if (!email) return;\n//   //   const fetchDocuments = async () => {\n//   //     try {\n//   //       const response = await fetch(`https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/simplifications/user/${email}`);\n//   //       const result = await response.json();\n//   //       if (response.ok) {\n//   //         const sortedDocs = result.data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));\n//   //         setDocuments(sortedDocs);\n//   //         if (sortedDocs.length > 0) {\n//   //           setSelectedDocument(sortedDocs[0]);\n//   //           setSelectedVersion(sortedDocs[0].outputText);\n//   //           setOutputText(sortedDocs[0].outputText);\n//   //         }\n//   //       } else {\n//   //         console.error(\"Error fetching documents:\", result.message);\n//   //       }\n//   //     } catch (error) {\n//   //       console.error(\"Error fetching documents:\", error);\n//   //     }\n//   //   };\n//   //   fetchDocuments();\n//   // }, [email]);\n//         // Sort by timestamp\n//         const sortedDocs = [...uniqueDocuments].sort(\n//           (a, b) => new Date(b.createdAt) - new Date(a.createdAt)\n//         );\n//         setDocuments(sortedDocs);\n//         // If first load with no selection, select the first document\n//         if (!selectedDocument && sortedDocs.length > 0) {\n//           handleDocumentClick(sortedDocs[0]);\n//         }\n//       }\n//     } catch (error) {\n//       console.error(\"Error fetching documents:\", error);\n//     }\n//   };\n//   const toggleExpandDoc = (docId) => {\n//     setExpandedDocs((prev) => ({\n//       ...prev,\n//       [docId]: !prev[docId],\n//     }));\n//   };\n//     // Handle document selection from sidebar\n//     const handleDocumentClick = (doc) => {\n//       setSelectedDocument(doc);\n//       setInputText(doc.inputText);\n//       setOutputText(doc.outputText);\n//       setSelectedVersion(doc.outputText);\n//       setSelectedVersionIndex(0);\n//       // Update diff when document changes\n//       const diffResult = generateDiff(doc.inputText, doc.outputText);\n//       setDiffHtml(diffResult);\n//       // Expand the document in the sidebar\n//       setExpandedDocs(prev => ({\n//         ...prev,\n//         [doc._id]: true\n//       }));\n//       setIsSaveButtonEnabled(false);\n//     };\n//   // const handleDocumentClick = (doc) => {\n//   //   setSelectedDocument(doc);\n//   //   setSelectedVersion(doc.outputText);\n//   //   setOutputText(doc.outputText);\n//   //   setSelectedVersionIndex(0);\n//   // };\n//   // Handle version selection from sidebar\n//   const handleVersionChange = (docId, versionIndex) => {\n//     const doc = documents.find(d => d._id === docId);\n//     if (!doc) return;\n//     let selectedText;\n//     let sourceText = doc.inputText;\n//     if (versionIndex === 0) {\n//       // Original AI output\n//       selectedText = doc.outputText;\n//     } else if (doc.saveHistory && doc.saveHistory[versionIndex - 1]) {\n//       // Saved version\n//       selectedText = doc.saveHistory[versionIndex - 1].finalText;\n//     } else if (doc.editHistory && doc.editHistory[versionIndex - 1]) {\n//       // Edit history\n//       selectedText = doc.editHistory[versionIndex - 1].text;\n//     } else {\n//       return;\n//     }\n//     setSelectedVersion(selectedText);\n//     setOutputText(selectedText);\n//     setSelectedDocument(doc);\n//     setSelectedVersionIndex(Number(versionIndex));\n//     // Update diff with the selected version\n//     const diffResult = generateDiff(sourceText, selectedText);\n//     setDiffHtml(diffResult);\n//     setIsSaveButtonEnabled(false);\n//   };\n//   // const handleVersionChange = (docId, versionIndex) => {\n//   //   const doc = documents.find((d) => d._id === docId);\n//   //   if (!doc) return;\n//   //   const selectedText =\n//   //     versionIndex === \"0\"\n//   //       ? doc.outputText\n//   //       : doc.saveHistory[versionIndex - 1].finalText;\n//   //   setSelectedVersion(selectedText);\n//   //   setOutputText(selectedText);\n//   //   setSelectedDocument(doc);\n//   //   setSelectedVersionIndex(versionIndex);\n//   // };\n//   // Initial setup and data loading\n//   useEffect(() => {\n//     if (email) {\n//       fetchDocumentHistory();\n//     }\n//     const savedState = JSON.parse(localStorage.getItem(\"reviewPageState\"));\n//     if (savedState) {\n//       setOutputText(savedState.outputText || \"\");\n//       setEditHistory(savedState.editHistory || []);\n//     } else {\n//       setOutputText(initialOutputText);\n//       setEditHistory(restoredEditHistory || []);\n//     }\n//   }, [email, initialOutputText, restoredEditHistory]);\n//   // Save state to localStorage when it changes\n//   useEffect(() => {\n//     const reviewPageState = {\n//       inputText: selectedDocument?.inputText || inputText,\n//       outputText,\n//       editHistory\n//     };\n//     localStorage.setItem(\"reviewPageState\", JSON.stringify(reviewPageState));\n//   }, [outputText, editHistory, inputText, selectedDocument]);\n//   // Update word counts when text changes\n//   useEffect(() => {\n//     const { words: inputWords, chars: inputChars } = countWordsAndChars(selectedDocument?.inputText || inputText);\n//     const { words: outputWords, chars: outputChars } = countWordsAndChars(outputText);\n//     setInputWordCount(inputWords);\n//     setInputCharCount(inputChars);\n//     setOutputWordCount(outputWords);\n//     setOutputCharCount(outputChars);\n//   }, [inputText, outputText, selectedDocument]);\n//   // Update diff when shown/hidden\n//   useEffect(() => {\n//     if (showDifference) {\n//       const diffResult = generateDiff(selectedDocument?.inputText || inputText, outputText);\n//       setDiffHtml(diffResult);\n//     }\n//   }, [showDifference, inputText, outputText, selectedDocument]);\n//   // useEffect(() => {\n//   //   const reviewPageState = {\n//   //     inputText,\n//   //     outputText,\n//   //     editHistory,\n//   //   };\n//   //   localStorage.setItem(\"reviewPageState\", JSON.stringify(reviewPageState));\n//   // }, [outputText, editHistory, inputText]);\n//   // useEffect(() => {\n//   //   const savedState = JSON.parse(localStorage.getItem(\"reviewPageState\"));\n//   //   if (savedState) {\n//   //     setOutputText(savedState.outputText || \"\");\n//   //     setEditHistory(savedState.editHistory || []);\n//   //   } else {\n//   //     setOutputText(initialOutputText);\n//   //     setEditHistory(restoredEditHistory || []);\n//   //   }\n//   //   if (!localStorage.getItem(\"initialAIOutput\")) {\n//   //     localStorage.setItem(\"initialAIOutput\", initialOutputText);\n//   //   }\n//   //  saveSimplification(); // Save the initial inputText and outputText\n//   //   setIsSaveButtonEnabled(true);\n//   // }, [initialOutputText, restoredEditHistory]);\n//   // useEffect(() => {\n//   //   const diffResult = generateDiff(inputText, outputText);\n//   //   setDiffHtml(diffResult);\n//   //  // saveSimplification();\n//   // }, [inputText, outputText]);\n//   // useEffect(() => {\n//   //   saveSimplification(); \n//   //   setIsSaveButtonEnabled(true);\n//   //   const savedState = JSON.parse(localStorage.getItem(\"reviewPageState\"));\n//   //   if (savedState) {\n//   //     setOutputText(savedState.outputText || \"\");\n//   //     setEditHistory(savedState.editHistory || []);\n//   //   }\n//   // }, []);\n//   // useEffect(() => {\n//   //   const { words: inputWords, chars: inputChars } = countWordsAndChars(inputText);\n//   //   const { words: outputWords, chars: outputChars } = countWordsAndChars(outputText);\n//   //   setInputWordCount(inputWords);\n//   //   setInputCharCount(inputChars);\n//   //   setOutputWordCount(outputWords);\n//   //   setOutputCharCount(outputChars);\n//   // }, [inputText, outputText]);\n//   const handleHistoryClick = (edit) => {\n//     setOutputText(edit.text);\n//     const diffResult = generateDiff(inputText, edit.text);\n//     setDiffHtml(diffResult);\n//     setIsEditable(false);\n//   };\n//   return (\n//     <>\n//       <nav className={styles.navbar}>\n//         {/* <h1>Text Simplification Tool</h1> */}\n//         <h1 \n//     onClick={() => window.location.href = \"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/\"}\n//     style={{ cursor: \"pointer\" }} // Makes it look clickable\n//  \t\t>\n// \t\tText Simplification Tool</h1>\n//         <button className={styles.white_btn} onClick={handleLogout}>\n//           Logout\n//         </button>\n//       </nav>\n//       <div className={styles.container}>\n//         {/* Sidebar */}\n//         <div\n//           className={`${styles.sidebar} ${\n//             isSidebarVisible ? styles.expanded : \"\"\n//           }`}\n//         >\n//           <button\n//             className={styles.historyIcon}\n//             onClick={() => setIsSidebarVisible(!isSidebarVisible)}\n//           >\n//              ðŸ•’   <p style={{ fontSize: \"15px\" }}> History </p> \n//           </button>\n//         {isSidebarVisible && (\n//             <div className={styles.historyContent}>\n//               <button className={styles.closeButton} onClick={() => setIsSidebarVisible(false)}>âœ–</button>\n//               <ul className={styles.historyList}>\n//                 {documents.map((doc, index) => (\n//                   <li key={doc._id} className={styles.historyItem}>\n//                     {/* <div onClick={() => toggleExpandDoc(doc._id)} className={styles.docHeader}> */}\n//                     <div\n//                       // onClick={() => toggleExpandDoc(doc._id)}\n//                       onClick={() => {\n//                         toggleExpandDoc(doc._id);\n//                         handleDocumentClick(doc);\n//                       }}\n//                       className={`${styles.docHeader} ${selectedDocument?._id === doc._id ? styles.activeDoc : \"\"}`}\n//                     >\n//                       {/* <strong>Document {index + 1}</strong>  */}\n//                       <strong>Document {documents.length - index}</strong> ({doc.inputText.substring(0, 20)}..., {new Date(doc.createdAt).toLocaleDateString()})\n//                     </div>\n//                     {expandedDocs[doc._id] && (\n//                       <ul className={styles.versionList}>\n//                         <li key=\"0\" onClick={() => handleVersionChange(doc._id, 0)} className={selectedVersionIndex === 0 && selectedDocument?._id === doc._id ? styles.activeVersion : \"\"}>\n//                           Version 1 (Generated Text)\n//                         </li>\n//                         {doc.saveHistory && doc.saveHistory.map((version, vIndex) => (\n//                           <li\n//                             key={vIndex + 1}\n//                             onClick={() => handleVersionChange(doc._id, vIndex + 1)}\n//                             className={selectedVersionIndex === vIndex + 1 && selectedDocument?._id === doc._id ? styles.activeVersion : \"\"}\n//                           >\n//                             Version {vIndex + 2} (Saved on {new Date(version.timestamp).toLocaleDateString()})\n//                           </li>\n//                         ))}\n//                       </ul>\n//                     )}\n//                   </li>\n//                 ))}\n//               </ul>\n//             </div>\n//           )}\n//         {/* <div className={styles.versionSelector}>\n//           <label>Select Version:</label>\n//           <select onChange={handleVersionChange} value={documents.indexOf(selectedDocument)}>\n//             <option value=\"0\">Version 1 (Generated Text)</option>\n//             {selectedDocument?.saveHistory.map((version, index) => (\n//               <option key={index + 1} value={index + 1}>\n//                 Version {index + 2} (Saved on {new Date(version.timestamp).toLocaleDateString()})\n//               </option>\n//             ))}\n//           </select>\n//         </div> */}\n//         </div>\n//         {/* Main Content */}\n//         <div\n//           className={`${styles.mainContent} ${\n//             isSidebarVisible ? styles.withSidebar : \"\"\n//           }`}\n//         >\n// \t\t\t<div className={styles.description}>\n// \t\t\t<p>\n//         Please review the simplified text carefully and if needed, correct/edit it to suit your requirements. Once you are satisfied with your revisions, save the final version and complete the short survey to provide your feedback.\n//       </p>\n// \t\t\t</div>\n// \t\t\t<div className={styles.textareas_container}>\n//   {/* Input Text */}\n//   <div className={styles.text_container}>\n//     <div className={styles.labelWrapper}>\n//       <label className={styles.label} htmlFor=\"inputText\">\n//         Input Text\n//       </label>\n//       <div className={styles.actions}>\n//       <div\n//         className={styles.copyIcon}\n//         onClick={() => handleCopy(inputText)}\n//         title=\"Copy to Clipboard\"\n//       >\n//         ðŸ“‹ {/* Clipboard Emoji */}\n//         </div>\n//         <div\n//         className={styles.copyIcon}\n//         onClick={() => handleDownload(inputText, \"InputText\", \"txt\")}\n//         title=\"Download as .txt file\"\n//       >\n//         ðŸ“¥ {/* Download Icon */}\n//       </div>\n//             {/* New Re-simplify Button */}\n//       <div\n//         className={styles.copyIcon}\n//         onClick={handleResimplify}\n//         title=\"Re-simplify Text\"\n//         style={{ cursor: isLoading ? \"not-allowed\" : \"pointer\", opacity: isLoading ? 0.6 : 1 }}\n//         >\n//           {isLoading ? \"âŒ›\" : \"ðŸ”„\"}\n//       </div>\n//       </div>\n//     </div>\n//     <p className={styles.countText}>Words: {inputWordCount} | Characters: {inputCharCount}</p>\n//     {/* <textarea id=\"inputText\" className={styles.textarea} value={selectedDocument?.inputText || \"\"} readOnly></textarea> */}\n//     <textarea\n//       id=\"inputText\"\n//       className={`${styles.textarea} ${styles.side_by_side}`}\n//       value={selectedDocument?.inputText || inputText}\n//       readOnly\n//     ></textarea>\n//   </div>\n// \t\t\t{/* Output Text Box */}\n// <div className={styles.text_container}>\n//   <div className={styles.labelWrapper}>\n//     <label className={styles.label} htmlFor=\"outputText\">\n//       AI-generated Text\n//     </label>\n//     <div className={styles.actions}>\n//       <div\n//         className={styles.copyIcon}\n//         onClick={() => handleCopy(outputText)}\n//         title=\"Copy to Clipboard\"\n//       >\n//         ðŸ“‹ {/* Clipboard Emoji */}\n//       </div>\n//       <div\n//         className={styles.copyIcon}\n//         onClick={() => handleDownload(outputText, \"GeneratedText\", \"txt\")}\n//         title=\"Download as .txt file\"\n//       >\n//         ðŸ“¥ {/* Download Icon */}\n//       </div>\n//       <button\n//         className={styles.toggleDiffBtn}\n//         onClick={() => setShowDifference(!showDifference)}\n//       >\n//         {showDifference ? \"Hide Difference with input text\" : \"Show Difference with input text\"}\n//       </button>\n//     </div>\n//   </div>\n//     {/* Word and Character Count */}\n//     <p className={styles.countText}>Words: {outputWordCount} | Characters: {outputCharCount}</p>\n//   <textarea\n//     id=\"outputText\"\n//     className={`${styles.output_box} ${styles.side_by_side}`}\n//     value={outputText}\n//     onChange={handleEditChange}\n//     readOnly={isEditable}\n//     placeholder=\"Output\"\n//   ></textarea>\n//   {/* <div\n//     ref={contentEditableRef}\n//     contentEditable={!isEditable}\n//     className={`${styles.output_box} ${styles.side_by_side} ${styles.editableDiv}`}\n//     onInput={(e) => handleLiveEdit(e)}\n//     dangerouslySetInnerHTML={{ __html: diffHtml }}\n//   ></div> */}\n// </div>\n//             {/* Difference Text */}\n// \t\t\t{showDifference && (\n// \t\t\t\t<div className={styles.text_container}>\n//           <div className={styles.labelWrapper}>\n//             <label className={styles.label} htmlFor=\"diffText\">\n//               Difference from input text\n//             </label>\n//           </div>   \n// \t\t\t\t\t<div\n//             id=\"diffText\"\n//             className={`${styles.output_box} ${styles.side_by_side}`}\n//             dangerouslySetInnerHTML={{ __html: diffHtml }}\n// \t\t\t\t\t>\n//           </div>\n// \t\t\t\t {/* )} */}\n// \t\t\t\t</div>\n// \t\t\t)}\n// \t\t\t</div>\n//           {/* Buttons */}\n// \t\t\t<div className={styles.button_container}>\n//     \t\t\t\t{/* <button\n//     \t\t\t\t\tclassName={`${styles.save_btn} ${styles.text_btn}`}\n//               onClick={saveFinalOutput}\n//               disabled={!isSaveButtonEnabled || isLoading}\n//               title={!isSaveButtonEnabled ? \"Please make an edit before submitting.\" : \"\"}\n//     \t\t\t\t>\n//     \t\t\t\t\tSubmit\n//     \t\t\t\t</button> */}\n//             <button\n//             className={styles.submit_btn}\n//             onClick={saveFinalOutput}\n//             disabled={!isSaveButtonEnabled || isLoading}\n//             title={!isSaveButtonEnabled ? \"Please make an edit before saving again.\" : \"\"}\n//             >\n//                           {isLoading ? \"Saving...\" : \"Save\"}\n//             </button>\n//       </div>\n//   {/* Survey Prompt (Appears Only After Submitting) */}\n//   {showSurveyPrompt && (\n//     <div className={styles.survey_prompt} ref={surveyRef}>\n//       <p className={styles.survey_text}>\n//         Please take the survey to help us improve.\n//         <button\n//           className={styles.survey_btn}\n//           onClick={() => {\n//             // const currentOutput = document.getElementById(\"outputText\")?.value;\n//             // const initialAIOutput = localStorage.getItem(\"initialAIOutput\") || initialOutputText;\n//             const currentOutput = outputText;\n//             const initialAIOutput = selectedDocument?.outputText || initialOutputText;\n//             navigate(\"/survey\", {\n//               state: {\n//                 email: email,\n//                 inputText: selectedDocument?.inputText || inputText,\n//                 outputText: initialAIOutput,\n//                 editHistory,\n//                 saveHistory: [\n//                   ...(saveHistory || []), \n//                   { \n//                     timestamp: new Date().toISOString(), \n//                     finalText: currentOutput \n//                   }\n//                 ],\n//               },\n//             });\n//           }}\n//         >\n//             {/* // const reviewPageState = { inputText, outputText: currentOutput, editHistory, saveHistory };\n//             // localStorage.setItem(\"reviewPageState\", JSON.stringify(reviewPageState));\n//             navigate(\"/survey\", {\n//               state: {\n//                 email: JSON.parse(localStorage.getItem(\"user\")).email,\n//                 inputText,\n//                 outputText: initialAIOutput,\n//                 editHistory,\n//                 saveHistory: [...saveHistory, { timestamp: new Date().toISOString(), finalText: currentOutput }],\n//               },\n//             });\n//           }}\n//         > */}\n//           ðŸ“‘ Take the Survey\n//         </button>\n//       </p>\n//     </div>\n//   )}\n// <p className={styles.help_text}>Need Help? <a href=\"mailto:anukumar@uw.edu\">Contact Support</a></p>\n//         </div>\n//       </div>\n//     </>\n//   );\n// };\n// export default Review;\nimport React,{useState,useEffect,useRef}from\"react\";import{useLocation,useNavigate}from\"react-router-dom\";import DiffMatchPatch from\"diff-match-patch\";import{FaRegCopy,FaDownload}from\"react-icons/fa\";import{saveAs}from\"file-saver\";import styles from\"./styles.module.css\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const Review=()=>{const{state}=useLocation();const initialState=state||{inputText:\"\",outputText:\"\",editHistory:[]};// Use initial values from location state\nconst[inputText,setInputText]=useState(initialState.inputText);const[outputText,setOutputText]=useState(initialState.outputText);const[editHistory,setEditHistory]=useState(initialState.editHistory||[]);const[saveHistory,setSaveHistory]=useState([]);const[showDifference,setShowDifference]=useState(false);const[diffHtml,setDiffHtml]=useState(\"\");const[isSaveButtonEnabled,setIsSaveButtonEnabled]=useState(false);const[isLoading,setIsLoading]=useState(false);const[showSurveyPrompt,setShowSurveyPrompt]=useState(false);const[isSidebarVisible,setIsSidebarVisible]=useState(false);// Document selection states\nconst[documents,setDocuments]=useState([]);const[selectedDocument,setSelectedDocument]=useState(null);const[selectedVersion,setSelectedVersion]=useState(null);const[selectedVersionIndex,setSelectedVersionIndex]=useState(0);const[expandedDocs,setExpandedDocs]=useState({});// Word count states\nconst[inputWordCount,setInputWordCount]=useState(0);const[inputCharCount,setInputCharCount]=useState(0);const[outputWordCount,setOutputWordCount]=useState(0);const[outputCharCount,setOutputCharCount]=useState(0);const navigate=useNavigate();const surveyRef=useRef(null);// Safely get user from localStorage\nconst getUserEmail=()=>{try{const user=JSON.parse(localStorage.getItem(\"user\"));return(user===null||user===void 0?void 0:user.email)||\"\";}catch(error){console.error(\"Failed to parse user from localStorage:\",error);return\"\";}};const email=getUserEmail();// Count words and characters\nconst countWordsAndChars=text=>{if(!text)return{words:0,chars:0};const words=text.trim().split(/\\s+/).filter(Boolean).length;const chars=text.length;return{words,chars};};// Generate difference between texts\nconst generateDiff=(input,output)=>{if(!input||!output)return\"\";const dmp=new DiffMatchPatch();const diffs=dmp.diff_main(input,output);dmp.diff_cleanupSemantic(diffs);const html=diffs.map(_ref=>{let[op,text]=_ref;if(op===DiffMatchPatch.DIFF_INSERT){return`<span style=\"background-color: #d4fcdc; color: green;\">${text}</span>`;}else if(op===DiffMatchPatch.DIFF_DELETE){return`<span style=\"background-color: #ffecec; color: red; text-decoration: line-through;\">${text}</span>`;}else{return`<span>${text}</span>`;}}).join(\"\");return html;};// Handle user logout\nconst handleLogout=()=>{localStorage.removeItem(\"token\");localStorage.removeItem(\"reviewPageState\");navigate(\"/Login\");};// Handle re-simplify request\nconst handleResimplify=async()=>{if(!inputText.trim())return;setIsLoading(true);try{const generatePrompt=text=>`\n        You are an expert in accessible communication, tasked with transforming complex text into clear, accessible plain language for individuals with Intellectual and Developmental Disabilities (IDD) or those requiring simplified content. Retain all essential information and intent while prioritizing readability, comprehension, and inclusivity.\n        \n        Text simplification refers to rewriting or adapting text to make it easier to read and understand while keeping the same level of detail and precision. Make sure you focus on simplification and not summarization. The length of generated output text must be similar to that of input text.\n        \n        Guidelines for Simplification:\n        Vocabulary and Terminology:\n        Replace uncommon, technical, or abstract words with simple, everyday language.\n        Define unavoidable complex terms in plain language within parentheses upon first use (example: \"cardiologist (heart doctor)\").\n        Avoid idioms, metaphors, sarcasm, or culturally specific references.\n        \n        Sentence Structure:\n        Use short sentences (10-15 words max). Break long sentences into 1â€“2 ideas each.\n        Prefer active voice (example: \"The doctor examined the patient\" vs. \"The patient was examined by the doctor\").\n        Avoid nested clauses, passive voice, and ambiguous pronouns (example: \"they,\" \"it\").\n        \n        \"${text}\"`;const splitTextIntoChunks=(text,maxTokens)=>{const words=text.split(/\\s+/);let chunks=[];let currentChunk=[];for(let word of words){if(currentChunk.join(\" \").length+word.length<maxTokens){currentChunk.push(word);}else{chunks.push(currentChunk.join(\" \"));currentChunk=[word];}}if(currentChunk.length>0)chunks.push(currentChunk.join(\" \"));return chunks;};// Use either the selected document's input text or the current inputText state\nconst textToSimplify=(selectedDocument===null||selectedDocument===void 0?void 0:selectedDocument.inputText)||inputText;const chunks=splitTextIntoChunks(textToSimplify,10000);let combinedOutput=\"\";for(let chunk of chunks){var _data$response;const prompt=generatePrompt(chunk);const response=await fetch(\"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/gpt4\",{method:\"POST\",headers:{\"Content-Type\":\"application/json\"},body:JSON.stringify({prompt})});if(!response.ok){console.error(\"Error with API request:\",response.status);continue;// Skip this chunk if the API request failed\n}const data=await response.json();const newOutput=(data===null||data===void 0?void 0:(_data$response=data.response)===null||_data$response===void 0?void 0:_data$response.replace(/^\"|\"$/g,\"\"))||\"No response received.\";combinedOutput+=newOutput+\" \";}setOutputText(combinedOutput.trim());// Update diff when output text changes\nconst diffResult=generateDiff(textToSimplify,combinedOutput.trim());setDiffHtml(diffResult);setIsSaveButtonEnabled(true);}catch(error){console.error(\"Error fetching GPT-4o response:\",error);alert(\"An error occurred while simplifying the text. Please try again.\");}setIsLoading(false);};// Save edit to history in database\nconst saveEditToHistory=async editedText=>{try{if(!email){console.error(\"User email not found, cannot save edit\");return;}const numWords=editedText.trim().split(/\\s+/).filter(Boolean).length;const numChars=editedText.length;const response=await fetch(\"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/simplifications/edit\",{method:\"PUT\",headers:{\"Content-Type\":\"application/json\"},body:JSON.stringify({email,inputText:(selectedDocument===null||selectedDocument===void 0?void 0:selectedDocument.inputText)||inputText,editedText,numWords,numChars})});if(response.ok){console.log(\"Edit saved to history.\");// Refresh documents after saving edit\nfetchDocumentHistory();}else{const error=await response.json();console.error(\"Error saving edit to history:\",error.message);}}catch(error){console.error(\"Error saving edit to history:\",error);}};// Save final output to database\nconst saveFinalOutput=async()=>{setIsLoading(true);try{if(!email){alert(\"User information not found. Please log in again.\");navigate(\"/login\");return;}const numWords=outputText.trim().split(/\\s+/).filter(Boolean).length;const numChars=outputText.length;const response=await fetch(\"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/simplifications/save\",{method:\"PUT\",headers:{\"Content-Type\":\"application/json\"},body:JSON.stringify({email,inputText:(selectedDocument===null||selectedDocument===void 0?void 0:selectedDocument.inputText)||inputText,finalText:outputText,numWords,numChars})});const timestamp=new Date().toISOString();setEditHistory(prev=>[...prev,{timestamp,text:outputText}]);if(response.ok){console.log(\"Final output saved successfully.\");setIsSaveButtonEnabled(false);setShowSurveyPrompt(true);// Automatically scroll to survey prompt\nsetTimeout(()=>{if(surveyRef.current){surveyRef.current.scrollIntoView({behavior:\"smooth\",block:\"center\"});}},300);setSaveHistory(prev=>[...prev,{timestamp,finalText:outputText}]);// Refresh documents after saving\nfetchDocumentHistory();}else{const error=await response.json();console.error(\"Error saving final output:\",error.message);alert(\"Error saving your changes. Please try again.\");}}catch(error){console.error(\"Error saving final output:\",error);alert(\"Error saving your changes. Please try again.\");}finally{setIsLoading(false);}};// Handle edit changes\nconst handleEditChange=event=>{const updatedText=event.target.value;setOutputText(updatedText);setIsSaveButtonEnabled(true);// Update diff when output text changes\nconst diffResult=generateDiff((selectedDocument===null||selectedDocument===void 0?void 0:selectedDocument.inputText)||inputText,updatedText);setDiffHtml(diffResult);// Save the change to edit history in MongoDB after a delay (debouncing)\nconst timeoutId=setTimeout(()=>{saveEditToHistory(updatedText);},2000);// 2 second delay\nreturn()=>clearTimeout(timeoutId);};// Copy text to clipboard\nconst handleCopy=text=>{navigator.clipboard.writeText(text).then(()=>{alert(\"Copied to clipboard!\");},err=>{console.error(\"Failed to copy text:\",err);});};// Download text as file\nconst handleDownload=(text,filename,format)=>{const blob=new Blob([text],{type:\"text/plain;charset=utf-8\"});saveAs(blob,`${filename}.${format}`);};// Fetch document history from database\nconst fetchDocumentHistory=async()=>{if(!email){console.log(\"Email not available, skipping document history fetch\");return;}try{const response=await fetch(`https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/simplifications/user/${email}`);if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}const result=await response.json();if(result.data){// Group documents by inputText to avoid duplicates\nconst uniqueDocuments=[];const inputTextMap=new Map();result.data.forEach(doc=>{// Use inputText as the key for grouping\nif(!inputTextMap.has(doc.inputText)){inputTextMap.set(doc.inputText,doc);uniqueDocuments.push(doc);}else{// If we already have this inputText, merge the save history\nconst existingDoc=inputTextMap.get(doc.inputText);// Merge edit history if it exists\nif(doc.editHistory&&doc.editHistory.length>0){existingDoc.editHistory=[...(existingDoc.editHistory||[]),...doc.editHistory];}// Merge save history if it exists\nif(doc.saveHistory&&doc.saveHistory.length>0){existingDoc.saveHistory=[...(existingDoc.saveHistory||[]),...doc.saveHistory];}// Update the map with the merged document\ninputTextMap.set(doc.inputText,existingDoc);}});// Sort by timestamp\nconst sortedDocs=[...uniqueDocuments].sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));setDocuments(sortedDocs);// If first load with no selection, select the first document\nif(!selectedDocument&&sortedDocs.length>0){handleDocumentClick(sortedDocs[0]);}}}catch(error){console.error(\"Error fetching documents:\",error);}};// Toggle document expansion in sidebar\nconst toggleExpandDoc=docId=>{setExpandedDocs(prev=>({...prev,[docId]:!prev[docId]}));};// Handle document selection from sidebar\nconst handleDocumentClick=doc=>{setSelectedDocument(doc);setInputText(doc.inputText);// Important: update the inputText state\nsetOutputText(doc.outputText);setSelectedVersion(doc.outputText);setSelectedVersionIndex(0);// Update diff when document changes\nconst diffResult=generateDiff(doc.inputText,doc.outputText);setDiffHtml(diffResult);// Expand the document in the sidebar\nsetExpandedDocs(prev=>({...prev,[doc._id]:true}));setIsSaveButtonEnabled(false);};// Handle version selection from sidebar\nconst handleVersionChange=(docId,versionIndex)=>{const doc=documents.find(d=>d._id===docId);if(!doc)return;let selectedText;let sourceText=doc.inputText;if(versionIndex===0){// Original AI output\nselectedText=doc.outputText;}else if(doc.saveHistory&&doc.saveHistory[versionIndex-1]){// Saved version\nselectedText=doc.saveHistory[versionIndex-1].finalText;}else if(doc.editHistory&&doc.editHistory[versionIndex-1]){// Edit history\nselectedText=doc.editHistory[versionIndex-1].text;}else{return;}setSelectedVersion(selectedText);setOutputText(selectedText);setSelectedDocument(doc);setInputText(doc.inputText);// Update inputText state when version changes\nsetSelectedVersionIndex(Number(versionIndex));// Update diff with the selected version\nconst diffResult=generateDiff(sourceText,selectedText);setDiffHtml(diffResult);setIsSaveButtonEnabled(false);};// Initial setup and data loading\nuseEffect(()=>{if(email){fetchDocumentHistory();}const savedState=JSON.parse(localStorage.getItem(\"reviewPageState\"));if(savedState){setInputText(savedState.inputText||\"\");setOutputText(savedState.outputText||\"\");setEditHistory(savedState.editHistory||[]);}else if(initialState.inputText){// Initialize from location state if available\nsetInputText(initialState.inputText);setOutputText(initialState.outputText);setEditHistory(initialState.editHistory||[]);}},[email,initialState.inputText,initialState.outputText,initialState.editHistory]);// Save state to localStorage when it changes\nuseEffect(()=>{const reviewPageState={inputText:(selectedDocument===null||selectedDocument===void 0?void 0:selectedDocument.inputText)||inputText,outputText,editHistory};localStorage.setItem(\"reviewPageState\",JSON.stringify(reviewPageState));},[outputText,editHistory,inputText,selectedDocument]);// Update word counts when text changes\nuseEffect(()=>{const{words:inputWords,chars:inputChars}=countWordsAndChars((selectedDocument===null||selectedDocument===void 0?void 0:selectedDocument.inputText)||inputText);const{words:outputWords,chars:outputChars}=countWordsAndChars(outputText);setInputWordCount(inputWords);setInputCharCount(inputChars);setOutputWordCount(outputWords);setOutputCharCount(outputChars);},[inputText,outputText,selectedDocument]);// Update diff when shown/hidden\nuseEffect(()=>{if(showDifference){const diffResult=generateDiff((selectedDocument===null||selectedDocument===void 0?void 0:selectedDocument.inputText)||inputText,outputText);setDiffHtml(diffResult);}},[showDifference,inputText,outputText,selectedDocument]);return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(\"nav\",{className:styles.navbar,children:[/*#__PURE__*/_jsx(\"h1\",{onClick:()=>window.location.href=\"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/\",style:{cursor:\"pointer\"},children:\"Text Simplification Tool\"}),/*#__PURE__*/_jsx(\"button\",{className:styles.white_btn,onClick:handleLogout,children:\"Logout\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:styles.container,children:[/*#__PURE__*/_jsxs(\"div\",{className:`${styles.sidebar} ${isSidebarVisible?styles.expanded:\"\"}`,children:[/*#__PURE__*/_jsxs(\"button\",{className:styles.historyIcon,onClick:()=>setIsSidebarVisible(!isSidebarVisible),children:[\"\\uD83D\\uDD52 \",/*#__PURE__*/_jsx(\"p\",{style:{fontSize:\"15px\"},children:\"History\"})]}),isSidebarVisible&&/*#__PURE__*/_jsxs(\"div\",{className:styles.historyContent,children:[/*#__PURE__*/_jsx(\"button\",{className:styles.closeButton,onClick:()=>setIsSidebarVisible(false),children:\"\\u2716\"}),/*#__PURE__*/_jsx(\"ul\",{className:styles.historyList,children:documents.map((doc,index)=>/*#__PURE__*/_jsxs(\"li\",{className:styles.historyItem,children:[/*#__PURE__*/_jsxs(\"div\",{onClick:()=>{toggleExpandDoc(doc._id);handleDocumentClick(doc);},className:`${styles.docHeader} ${(selectedDocument===null||selectedDocument===void 0?void 0:selectedDocument._id)===doc._id?styles.activeDoc:\"\"}`,children:[/*#__PURE__*/_jsxs(\"strong\",{children:[\"Document \",documents.length-index]}),/*#__PURE__*/_jsxs(\"span\",{className:styles.docPreview,children:[\"(\",doc.inputText.substring(0,20),\"...)\"]}),/*#__PURE__*/_jsx(\"span\",{className:styles.docDate,children:new Date(doc.createdAt).toLocaleDateString()})]}),expandedDocs[doc._id]&&/*#__PURE__*/_jsxs(\"ul\",{className:styles.versionList,children:[/*#__PURE__*/_jsx(\"li\",{onClick:()=>handleVersionChange(doc._id,0),className:selectedVersionIndex===0&&(selectedDocument===null||selectedDocument===void 0?void 0:selectedDocument._id)===doc._id?styles.activeVersion:\"\",children:\"Version 1 (Generated Text)\"},\"0\"),doc.saveHistory&&doc.saveHistory.map((version,vIndex)=>/*#__PURE__*/_jsxs(\"li\",{onClick:()=>handleVersionChange(doc._id,vIndex+1),className:selectedVersionIndex===vIndex+1&&(selectedDocument===null||selectedDocument===void 0?void 0:selectedDocument._id)===doc._id?styles.activeVersion:\"\",children:[\"Version \",vIndex+2,\" (Saved on \",new Date(version.timestamp).toLocaleDateString(),\")\"]},`save-${vIndex}`))]})]},doc._id))})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:`${styles.mainContent} ${isSidebarVisible?styles.withSidebar:\"\"}`,children:[/*#__PURE__*/_jsx(\"div\",{className:styles.description,children:/*#__PURE__*/_jsx(\"p\",{children:\"Please review the simplified text carefully and if needed, correct/edit it to suit your requirements. Once you are satisfied with your revisions, save the final version and complete the short survey to provide your feedback.\"})}),/*#__PURE__*/_jsxs(\"div\",{className:styles.textareas_container,children:[/*#__PURE__*/_jsxs(\"div\",{className:styles.text_container,children:[/*#__PURE__*/_jsxs(\"div\",{className:styles.labelWrapper,children:[/*#__PURE__*/_jsx(\"label\",{className:styles.label,htmlFor:\"inputText\",children:\"Input Text\"}),/*#__PURE__*/_jsxs(\"div\",{className:styles.actions,children:[/*#__PURE__*/_jsx(\"div\",{className:styles.copyIcon,onClick:()=>handleCopy((selectedDocument===null||selectedDocument===void 0?void 0:selectedDocument.inputText)||inputText),title:\"Copy to Clipboard\",children:\"\\uD83D\\uDCCB\"}),/*#__PURE__*/_jsx(\"div\",{className:styles.copyIcon,onClick:()=>handleDownload((selectedDocument===null||selectedDocument===void 0?void 0:selectedDocument.inputText)||inputText,\"InputText\",\"txt\"),title:\"Download as .txt file\",children:\"\\uD83D\\uDCE5\"}),/*#__PURE__*/_jsx(\"div\",{className:styles.copyIcon,onClick:handleResimplify,title:\"Re-simplify Text\",style:{cursor:isLoading?\"not-allowed\":\"pointer\",opacity:isLoading?0.6:1},children:isLoading?\"âŒ›\":\"ðŸ”„\"})]})]}),/*#__PURE__*/_jsxs(\"p\",{className:styles.countText,children:[\"Words: \",inputWordCount,\" | Characters: \",inputCharCount]}),/*#__PURE__*/_jsx(\"textarea\",{id:\"inputText\",className:`${styles.textarea} ${styles.side_by_side}`,value:(selectedDocument===null||selectedDocument===void 0?void 0:selectedDocument.inputText)||inputText,readOnly:true})]}),/*#__PURE__*/_jsxs(\"div\",{className:styles.text_container,children:[/*#__PURE__*/_jsxs(\"div\",{className:styles.labelWrapper,children:[/*#__PURE__*/_jsx(\"label\",{className:styles.label,htmlFor:\"outputText\",children:\"AI-generated Text\"}),/*#__PURE__*/_jsxs(\"div\",{className:styles.actions,children:[/*#__PURE__*/_jsx(\"div\",{className:styles.copyIcon,onClick:()=>handleCopy(outputText),title:\"Copy to Clipboard\",children:\"\\uD83D\\uDCCB\"}),/*#__PURE__*/_jsx(\"div\",{className:styles.copyIcon,onClick:()=>handleDownload(outputText,\"GeneratedText\",\"txt\"),title:\"Download as .txt file\",children:\"\\uD83D\\uDCE5\"}),/*#__PURE__*/_jsx(\"button\",{className:styles.toggleDiffBtn,onClick:()=>setShowDifference(!showDifference),children:showDifference?\"Hide Difference with input text\":\"Show Difference with input text\"})]})]}),/*#__PURE__*/_jsxs(\"p\",{className:styles.countText,children:[\"Words: \",outputWordCount,\" | Characters: \",outputCharCount]}),/*#__PURE__*/_jsx(\"textarea\",{id:\"outputText\",className:`${styles.output_box} ${styles.side_by_side}`,value:outputText,onChange:handleEditChange,placeholder:\"Output\"})]}),showDifference&&/*#__PURE__*/_jsxs(\"div\",{className:styles.text_container,children:[/*#__PURE__*/_jsx(\"div\",{className:styles.labelWrapper,children:/*#__PURE__*/_jsx(\"label\",{className:styles.label,htmlFor:\"diffText\",children:\"Difference from input text\"})}),/*#__PURE__*/_jsx(\"div\",{id:\"diffText\",className:`${styles.output_box} ${styles.side_by_side}`,dangerouslySetInnerHTML:{__html:diffHtml}})]})]}),/*#__PURE__*/_jsx(\"div\",{className:styles.button_container,children:/*#__PURE__*/_jsx(\"button\",{className:styles.submit_btn,onClick:saveFinalOutput,disabled:!isSaveButtonEnabled||isLoading,title:!isSaveButtonEnabled?\"Please make an edit before saving again.\":\"\",children:isLoading?\"Saving...\":\"Save\"})}),showSurveyPrompt&&/*#__PURE__*/_jsx(\"div\",{className:styles.survey_prompt,ref:surveyRef,children:/*#__PURE__*/_jsxs(\"p\",{className:styles.survey_text,children:[\"Please take the survey to help us improve.\",/*#__PURE__*/_jsx(\"button\",{className:styles.survey_btn,onClick:()=>{const currentOutput=outputText;const initialAIOutput=(selectedDocument===null||selectedDocument===void 0?void 0:selectedDocument.outputText)||initialState.outputText;navigate(\"/survey\",{state:{email:email,inputText:(selectedDocument===null||selectedDocument===void 0?void 0:selectedDocument.inputText)||inputText,outputText:initialAIOutput,editHistory,saveHistory:[...(saveHistory||[]),{timestamp:new Date().toISOString(),finalText:currentOutput}]}});},children:\"\\uD83D\\uDCD1 Take the Survey\"})]})}),/*#__PURE__*/_jsxs(\"p\",{className:styles.help_text,children:[\"Need Help? \",/*#__PURE__*/_jsx(\"a\",{href:\"mailto:anukumar@uw.edu\",children:\"Contact Support\"})]})]})]})]});};export default Review;","map":{"version":3,"names":["React","useState","useEffect","useRef","useLocation","useNavigate","DiffMatchPatch","FaRegCopy","FaDownload","saveAs","styles","jsx","_jsx","jsxs","_jsxs","Fragment","_Fragment","Review","state","initialState","inputText","outputText","editHistory","setInputText","setOutputText","setEditHistory","saveHistory","setSaveHistory","showDifference","setShowDifference","diffHtml","setDiffHtml","isSaveButtonEnabled","setIsSaveButtonEnabled","isLoading","setIsLoading","showSurveyPrompt","setShowSurveyPrompt","isSidebarVisible","setIsSidebarVisible","documents","setDocuments","selectedDocument","setSelectedDocument","selectedVersion","setSelectedVersion","selectedVersionIndex","setSelectedVersionIndex","expandedDocs","setExpandedDocs","inputWordCount","setInputWordCount","inputCharCount","setInputCharCount","outputWordCount","setOutputWordCount","outputCharCount","setOutputCharCount","navigate","surveyRef","getUserEmail","user","JSON","parse","localStorage","getItem","email","error","console","countWordsAndChars","text","words","chars","trim","split","filter","Boolean","length","generateDiff","input","output","dmp","diffs","diff_main","diff_cleanupSemantic","html","map","_ref","op","DIFF_INSERT","DIFF_DELETE","join","handleLogout","removeItem","handleResimplify","generatePrompt","splitTextIntoChunks","maxTokens","chunks","currentChunk","word","push","textToSimplify","combinedOutput","chunk","_data$response","prompt","response","fetch","method","headers","body","stringify","ok","status","data","json","newOutput","replace","diffResult","alert","saveEditToHistory","editedText","numWords","numChars","log","fetchDocumentHistory","message","saveFinalOutput","finalText","timestamp","Date","toISOString","prev","setTimeout","current","scrollIntoView","behavior","block","handleEditChange","event","updatedText","target","value","timeoutId","clearTimeout","handleCopy","navigator","clipboard","writeText","then","err","handleDownload","filename","format","blob","Blob","type","Error","result","uniqueDocuments","inputTextMap","Map","forEach","doc","has","set","existingDoc","get","sortedDocs","sort","a","b","createdAt","handleDocumentClick","toggleExpandDoc","docId","_id","handleVersionChange","versionIndex","find","d","selectedText","sourceText","Number","savedState","reviewPageState","setItem","inputWords","inputChars","outputWords","outputChars","children","className","navbar","onClick","window","location","href","style","cursor","white_btn","container","sidebar","expanded","historyIcon","fontSize","historyContent","closeButton","historyList","index","historyItem","docHeader","activeDoc","docPreview","substring","docDate","toLocaleDateString","versionList","activeVersion","version","vIndex","mainContent","withSidebar","description","textareas_container","text_container","labelWrapper","label","htmlFor","actions","copyIcon","title","opacity","countText","id","textarea","side_by_side","readOnly","toggleDiffBtn","output_box","onChange","placeholder","dangerouslySetInnerHTML","__html","button_container","submit_btn","disabled","survey_prompt","ref","survey_text","survey_btn","currentOutput","initialAIOutput","help_text"],"sources":["/Users/anukumar/Desktop/Autumn 2024/Text Simplification/textsimplification/client/src/components/Review/index.jsx"],"sourcesContent":["// import React, { useState, useEffect, useRef  } from \"react\";\n// import { useLocation, useNavigate } from \"react-router-dom\";\n// import DiffMatchPatch from \"diff-match-patch\";\n// import { FaRegCopy, FaDownload } from \"react-icons/fa\"; // Import FontAwesome icons\n// import { saveAs } from \"file-saver\";\n// import styles from \"./styles.module.css\";\n\n// const Review = () => {\n\n\n//   const { state } = useLocation();\n//   // const { inputText, outputText: initialOutputText, editHistory: restoredEditHistory } = state || {\n//   //   inputText: \"\",\n//   //   outputText: \"\",\n//   //   editHistory: [],\n//   // };\n//   const initialState = state || {\n//     inputText: \"\",\n//     outputText: \"\",\n//     editHistory: []\n//   };\n//   const [inputText, setInputText] = useState(initialState.inputText);\n//   const [outputText, setOutputText] = useState(initialOutputText);\n//   const [editHistory, setEditHistory] = useState(restoredEditHistory || []);\n//   const [saveHistory, setSaveHistory] = useState([]);\n\n//   const [showStats, setShowStats] = useState(false);\n\n\n//   const [diffHtml, setDiffHtml] = useState(\"\");\n//   const [isSaveButtonEnabled, setIsSaveButtonEnabled] = useState(false);\n//   const navigate = useNavigate();\n\n\n//   const [isEditable, setIsEditable] = useState(false);\n//   const [isSidebarVisible, setIsSidebarVisible] = useState(false);\n//   const [showDifference, setShowDifference] = useState(false);\n\n//   const [inputWordCount, setInputWordCount] = useState(0);\n//   const [inputCharCount, setInputCharCount] = useState(0);\n\n//   const [outputWordCount, setOutputWordCount] = useState(0);\n//   const [outputCharCount, setOutputCharCount] = useState(0);\n\n\n\n// //   const navigate = useNavigate();\n\n\n//   const [isHistoryVisible, setIsHistoryVisible] = useState(false); // Show/Hide history sidebar\n//   const contentEditableRef = useRef(null); // Reference to the contentEditable div\n\n\n// \tconst [isLoading, setIsLoading] = useState(false);\n\n// \tconst [isSaveButtonVisible, setIsSaveButtonVisible] = useState(true);\n// \tconst [showSurveyPrompt, setShowSurveyPrompt] = useState(false); // State for survey prompt\n\n//   const surveyRef = useRef(null);\n\n//   const user = JSON.parse(localStorage.getItem(\"user\"));\n//   const email = user?.email;\n\n//   const [documents, setDocuments] = useState([]);\n//   const [selectedDocument, setSelectedDocument] = useState(null);\n//   const [selectedVersion, setSelectedVersion] = useState(null);\n//   const [selectedVersionIndex, setSelectedVersionIndex] = useState(0); \n//   const [expandedDocs, setExpandedDocs] = useState({});\n\n//   const [liveEditedText, setLiveEditedText] = useState(initialOutputText);\n//   // const contentEditableRef = useRef(null);\n\n//   // const [outputText, setOutputText] = useState(\"\");\n\n\n//     const handleLogout = () => {\n//     localStorage.removeItem(\"token\");\n// \tnavigate(\"/Login\"); \n\n//   localStorage.removeItem(\"reviewPageState\"); // Clear the saved state\n\n//    // window.location.reload();\n//   };\n\n//   const countWordsAndChars = (text) => {\n//     const words = text.trim().split(/\\s+/).filter(Boolean).length;\n//     const chars = text.length;\n//     return { words, chars };\n//   };\n  \n//       // Function to calculate and render diff\n\n\n//       const generateDiff = (input, output) => {\n//         if (!input || !output) return \"\";\n\n//         const dmp = new DiffMatchPatch();\n//         const diffs = dmp.diff_main(input, output);\n//         dmp.diff_cleanupSemantic(diffs);\n      \n//         const html = diffs\n//           .map(([op, text]) => {\n//             if (op === DiffMatchPatch.DIFF_INSERT) {\n//               return `<span style=\"background-color: #d4fcdc; color: green;\">${text}</span>`;\n//             } else if (op === DiffMatchPatch.DIFF_DELETE) {\n//               return `<span style=\"background-color: #ffecec; color: red; text-decoration: line-through;\">${text}</span>`;\n//             } else {\n//               return `<span>${text}</span>`;\n//             }\n//           })\n//           .join(\"\");\n      \n//         return html;\n//       };\n      \n    \n// \t// Function to format the prompt with user input\n//   // const generatePrompt = (inputText) => {\n//   //   return `\n//   //   You are an expert in accessible communication, tasked with transforming complex text into clear, accessible plain language for individuals with Intellectual and Developmental Disabilities (IDD) or those requiring simplified content. Retain all essential information and intent while prioritizing readability, comprehension, and inclusivity.\n\n//   //   Text simplification refers to rewriting or adapting text to make it easier to read and understand while keeping the same level of detail and precision. Make sure you focus on simplification and not summarization. The length of generated output text must be similar to that of input text.\n\n//   //   Guidelines for Simplification:\n//   //   Vocabulary and Terminology:\n//   //   Replace uncommon, technical, or abstract words with simple, everyday language.\n//   //   Define unavoidable complex terms in plain language within parentheses upon first use (example: â€œcardiologist (heart doctor)â€).\n//   //   Avoid idioms, metaphors, sarcasm, or culturally specific references.\n\n//   //   Sentence Structure:\n//   //   Use short sentences (10--15 words max). Break long sentences into 1â€“2 ideas each.\n//   //   Prefer active voice (example: â€œThe doctor examined the patientâ€ vs. â€œThe patient was examined by the doctorâ€).\n//   //   Avoid nested clauses, passive voice, and ambiguous pronouns (example: â€œthey,â€ â€œitâ€).\n\n//   //   Clarity and Flow:\n//   //   Organize content logically, using headings/subheadings to group related ideas.\n//   //   Use bullet points or numbered lists for steps, options, or key points.\n//   //   Ensure each paragraph focuses on one main idea.\n\n//   //   Tone and Engagement:\n//   //   Write in a neutral, conversational tone (avoid formal or academic language).\n//   //   Address the reader directly with â€œyouâ€ or â€œweâ€ where appropriate.\n//   //   Use consistent terms for concepts (avoid synonyms that may confuse).\n\n//   //   Avoid Exclusionary Elements:\n//   //   Remove jargon, acronyms (unless defined), and expand abbreviations if needed (example: â€œASAPâ€ â†’ â€œas soon as possibleâ€).\n//   //   Eliminate metaphors, idioms, or implied meanings (example: â€œhit the booksâ€ â†’ â€œstudyâ€).\n//   //   Avoid double negatives (example: â€œnot uncommonâ€ â†’ â€œcommonâ€).\n\n//   //   Structural Support:\n//   //   Add clear headings to label sections (example: â€œHow to Apply for Benefitsâ€).\n//   //   Use formatting tools like bold for key terms or warnings.\n//   //   Chunk information into short paragraphs with line breaks for visual ease.\n\n//   //   Inclusivity Checks:\n//   //   Ensure content is free of bias, stereotypes, or assumptions about the reader.\n//   //   Use gender-neutral language (example: â€œtheyâ€ instead of â€œhe/sheâ€).\n\n\n//   //   Output Requirements:\n//   //   Return only the simplified text, without markdown, emojis, or images.\n//   //   Preserve original context, facts, and intent. Do not omit critical details.\n//   //   Prioritize clarity over brevity; focus on simplification and not summarization. The length of generated output text should be same or similar to that of input text.\n//   //   Do not simplify already simple text.\n\n//   //   Example Transformation:\n//   //   Original: â€œIndividuals experiencing adverse climatic conditions may necessitate relocation to mitigate health risks.â€\n//   //   Simplified: â€œIf weather conditions become dangerous, people might need to move to stay safe.â€\n\n//   //   For the provided input text, apply the above guidelines rigorously. Ensure the output is accessible to readers with varied cognitive abilities, emphasizing clarity, simplicity, and logical structure. Verify that the simplified text aligns with plain language standards like WCAG and PlainLanguage.gov.\n\n//   //   \"${inputText}\"\n//   //   `;\n//   //   };\n  \n//     // const splitTextIntoChunks = (text, maxTokens) => {\n//     // const words = text.split(\" \");\n//     // let chunks = [];\n//     // let currentChunk = [];\n    \n//     // for (let word of words) {\n//     //   if (currentChunk.join(\" \").length + word.length < maxTokens) {\n//     //   currentChunk.push(word);\n//     //   } else {\n//     //   chunks.push(currentChunk.join(\" \"));\n//     //   currentChunk = [word];\n//     //   }\n//     // }\n//     // if (currentChunk.length > 0) chunks.push(currentChunk.join(\" \"));\n//     // return chunks;\n//     // };\n\n//   const saveSimplification = async () => {\n//     try {\n//       const user = JSON.parse(localStorage.getItem(\"user\"));\n//       if (!user) return;\n\n\n//     const numWordsInput = inputText.trim().split(/\\s+/).filter(Boolean).length;\n//     const numCharsInput = inputText.length;\n//     const numWordsOutput = outputText.trim().split(/\\s+/).filter(Boolean).length;\n//     const numCharsOutput = outputText.length;\n\n//       const response = await fetch(\"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/simplifications\", {\n//         method: \"POST\",\n//         headers: { \"Content-Type\": \"application/json\" },\n//         body: JSON.stringify({\n//           userId: user._id,\n//           inputText,\n//           outputText,\n//           metrics: { numWordsInput, numCharsInput, numWordsOutput, numCharsOutput }\n\n//         }),\n//       });\n\n//       if (response.ok) {\n//         console.log(\"Simplification saved successfully.\");\n        \n//       } else {\n//         const error = await response.json();\n//         console.error(\"Error saving simplification:\", error.message);\n//       }\n//     } catch (error) {\n//       console.error(\"Error saving simplification:\", error);\n//     }\n//   };\n\n\n\n\n//   // const handleResimplify = async () => {\n//   //   if (!inputText.trim()) return;\n  \n//   //   setIsLoading(true); // Show loading state\n  \n//   //   try {\n\n//   //     const chunks = splitTextIntoChunks(inputText, 10000);\n//   //     let combinedOutput = \"\";\n    \n//   //     for (let chunk of chunks) {\n//   //     const prompt = generatePrompt(chunk);\n//   //     const response = await fetch(\"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/gpt4\", {\n//   //       method: \"POST\",\n//   //       headers: { \"Content-Type\": \"application/json\" },\n//   //       body: JSON.stringify({ prompt }),\n//   //     });\n      \n  \n//   //     if (!response.ok) {\n//   //       console.error(\"Error with API request:\", response.status);\n//   //       return;\n//   //     }\n  \n//   //     const data = await response.json();\n//   //     console.log(\"Full API Response: \", data);\n//   //     const newOutput = data?.response?.replace(/^\"|\"$/g, \"\") || \"No response received.\";\n  \n//   //     // Update System-generated Text\n//   //     combinedOutput += newOutput + \" \";\n//   //     console.log(\"Final Combined Output: \", combinedOutput);\n    \n//   //     }\n//   //     setOutputText(combinedOutput);\n//   //   } catch (error) {\n//   //     console.error(\"Error fetching GPT-4o response:\", error);\n//   //     setOutputText(\"An error occurred while simplifying the text.\");\n//   //   }\n  \n//   //   setIsLoading(false);\n//   // };\n\n\n//     // Handle re-simplify request\n//     const handleResimplify = async () => {\n//       if (!inputText.trim()) return;\n    \n//       setIsLoading(true);\n    \n//       try {\n//         const generatePrompt = (text) => `\n//     You are an expert in accessible communication, tasked with transforming complex text into clear, accessible plain language for individuals with Intellectual and Developmental Disabilities (IDD) or those requiring simplified content. Retain all essential information and intent while prioritizing readability, comprehension, and inclusivity.\n\n//     Text simplification refers to rewriting or adapting text to make it easier to read and understand while keeping the same level of detail and precision. Make sure you focus on simplification and not summarization. The length of generated output text must be similar to that of input text.\n\n//     Guidelines for Simplification:\n//     Vocabulary and Terminology:\n//     Replace uncommon, technical, or abstract words with simple, everyday language.\n//     Define unavoidable complex terms in plain language within parentheses upon first use (example: â€œcardiologist (heart doctor)â€).\n//     Avoid idioms, metaphors, sarcasm, or culturally specific references.\n\n//     Sentence Structure:\n//     Use short sentences (10--15 words max). Break long sentences into 1â€“2 ideas each.\n//     Prefer active voice (example: â€œThe doctor examined the patientâ€ vs. â€œThe patient was examined by the doctorâ€).\n//     Avoid nested clauses, passive voice, and ambiguous pronouns (example: â€œthey,â€ â€œitâ€).\n\n//     Clarity and Flow:\n//     Organize content logically, using headings/subheadings to group related ideas.\n//     Use bullet points or numbered lists for steps, options, or key points.\n//     Ensure each paragraph focuses on one main idea.\n\n//     Tone and Engagement:\n//     Write in a neutral, conversational tone (avoid formal or academic language).\n//     Address the reader directly with â€œyouâ€ or â€œweâ€ where appropriate.\n//     Use consistent terms for concepts (avoid synonyms that may confuse).\n\n//     Avoid Exclusionary Elements:\n//     Remove jargon, acronyms (unless defined), and expand abbreviations if needed (example: â€œASAPâ€ â†’ â€œas soon as possibleâ€).\n//     Eliminate metaphors, idioms, or implied meanings (example: â€œhit the booksâ€ â†’ â€œstudyâ€).\n//     Avoid double negatives (example: â€œnot uncommonâ€ â†’ â€œcommonâ€).\n\n//     Structural Support:\n//     Add clear headings to label sections (example: â€œHow to Apply for Benefitsâ€).\n//     Use formatting tools like bold for key terms or warnings.\n//     Chunk information into short paragraphs with line breaks for visual ease.\n\n//     Inclusivity Checks:\n//     Ensure content is free of bias, stereotypes, or assumptions about the reader.\n//     Use gender-neutral language (example: â€œtheyâ€ instead of â€œhe/sheâ€).\n\n\n//     Output Requirements:\n//     Return only the simplified text, without markdown, emojis, or images.\n//     Preserve original context, facts, and intent. Do not omit critical details.\n//     Prioritize clarity over brevity; focus on simplification and not summarization. The length of generated output text should be same or similar to that of input text.\n//     Do not simplify already simple text.\n\n//     Example Transformation:\n//     Original: â€œIndividuals experiencing adverse climatic conditions may necessitate relocation to mitigate health risks.â€\n//     Simplified: â€œIf weather conditions become dangerous, people might need to move to stay safe.â€\n\n//     For the provided input text, apply the above guidelines rigorously. Ensure the output is accessible to readers with varied cognitive abilities, emphasizing clarity, simplicity, and logical structure. Verify that the simplified text aligns with plain language standards like WCAG and PlainLanguage.gov.\n\n//           \"${text}\"`;\n        \n//         const splitTextIntoChunks = (text, maxTokens) => {\n//           const words = text.split(/\\s+/);\n//           let chunks = [];\n//           let currentChunk = [];\n        \n//           for (let word of words) {\n//             if (currentChunk.join(\" \").length + word.length < maxTokens) {\n//               currentChunk.push(word);\n//             } else {\n//               chunks.push(currentChunk.join(\" \"));\n//               currentChunk = [word];\n//             }\n//           }\n          \n//           if (currentChunk.length > 0) chunks.push(currentChunk.join(\" \"));\n//           return chunks;\n//         };\n        \n//         const chunks = splitTextIntoChunks(inputText, 10000);\n//         let combinedOutput = \"\";\n      \n//         for (let chunk of chunks) {\n//           const prompt = generatePrompt(chunk);\n//           const response = await fetch(\"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/gpt4\", {\n//             method: \"POST\",\n//             headers: { \"Content-Type\": \"application/json\" },\n//             body: JSON.stringify({ prompt }),\n//           });\n        \n//           if (!response.ok) {\n//             console.error(\"Error with API request:\", response.status);\n//             continue; // Skip this chunk if the API request failed\n//           }\n    \n//           const data = await response.json();\n//           const newOutput = data?.response?.replace(/^\"|\"$/g, \"\") || \"No response received.\";\n//           combinedOutput += newOutput + \" \";\n//         }\n        \n//         setOutputText(combinedOutput.trim());\n        \n//         // Update diff when output text changes\n//         const diffResult = generateDiff(inputText, combinedOutput.trim());\n//         setDiffHtml(diffResult);\n        \n//         setIsSaveButtonEnabled(true);\n//       } catch (error) {\n//         console.error(\"Error fetching GPT-4o response:\", error);\n//         alert(\"An error occurred while simplifying the text. Please try again.\");\n//       }\n    \n//       setIsLoading(false);\n//     };\n\n//   //\n//   const saveEditToHistory = async (editedText) => {\n//     try {\n//       const user = JSON.parse(localStorage.getItem(\"user\"));\n//       if (!user) return;\n\n//       const numWords = editedText.trim().split(/\\s+/).filter(Boolean).length;\n//       const numChars = editedText.length;\n\n//       const response = await fetch(\"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/simplifications/edit\", {\n//         method: \"PUT\",\n//         headers: { \"Content-Type\": \"application/json\" },\n//         body: JSON.stringify({\n//           email: user.email,\n//           inputText: selectedDocument?.inputText || inputText,\n//           // inputText,\n//           editedText,\n//           numWords,\n//           numChars\n//         }),\n//       });\n\n//       if (response.ok) {\n//         console.log(\"Edit saved to history.\");\n//         fetchDocumentHistory();\n//       } else {\n//         const error = await response.json();\n//         console.error(\"Error saving edit to history:\", error.message);\n//       }\n//     } catch (error) {\n//       console.error(\"Error saving edit to history:\", error);\n//     }\n//   };\n\n//   const saveFinalOutput = async () => {\n\n//     // const finalText = contentEditableRef.current?.innerText || \"\";\n//     // console.log(\"Final text to submit:\", finalText);\n//     // setOutputText(finalText);\n\n\n//     setIsLoading(true);\n\n//     try {\n//       const user = JSON.parse(localStorage.getItem(\"user\"));\n//       if (!user) return;\n\n//       const numWords = outputText.trim().split(/\\s+/).filter(Boolean).length;\n//       const numChars = outputText.length;\n//       const finalText = document.getElementById(\"outputText\")?.value || outputText;\n\n//       const response = await fetch(\"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/simplifications/save\", {\n//         method: \"PUT\",\n//         headers: { \"Content-Type\": \"application/json\" },\n//         body: JSON.stringify({\n//           email: user.email,\n//           // inputText,\n//           inputText: selectedDocument?.inputText || inputText,\n//           finalText: outputText,\n//           numWords,\n//           numChars,\n//           readability: 4, // Example value, replace with user input\n//           accuracy: 5, // Example value, replace with user input\n//           comments: \"Looks good.\" // Example value, replace with user input\n//         }),\n//       });\n\n//     const timestamp = new Date().toISOString();\n//     setEditHistory((prev) => [\n//       ...prev,\n//       { timestamp, text: finalText},\n//     ]);\n\n//       if (response.ok) {\n//         console.log(\"Final output saved successfully.\");\n//         setIsSaveButtonEnabled(false); // Disable save button\n//         setShowSurveyPrompt(true);    // Ensure survey prompt is displayed\n\n//         // âœ… Automatically scroll to survey prompt\n//         setTimeout(() => {\n//             if (surveyRef.current) {\n//                 surveyRef.current.scrollIntoView({ behavior: \"smooth\", block: \"center\" });\n//             }\n//         }, 300);\n\n//         const timestamp = new Date().toISOString();\n//         setSaveHistory((prev) => [...prev, { timestamp, finalText: finalText}]); // ðŸ”¹ Save to history\n//         fetchDocumentHistory();\n//       } else {\n//         const error = await response.json();\n//         console.error(\"Error saving final output:\", error.message);\n//       }\n//     } catch (error) {\n//       console.error(\"Error saving final output:\", error);\n//     } finally {\n//       setIsLoading(false);\n//     }\n//   };\n\n//   const handleEditChange = (event) => {\n//     const updatedText = event.target.value;\n//     setOutputText(updatedText);\n//     setIsSaveButtonEnabled(true); // Enable save button on edit\n//     // Update diff when output text changes\n//     const diffResult = generateDiff(selectedDocument?.inputText || inputText, updatedText);\n//     setDiffHtml(diffResult);\n\n//     // Save the change to edit history in MongoDB after a delay (debouncing)\n//     const timeoutId = setTimeout(() => {\n//       saveEditToHistory(updatedText);\n//     }, 2000); // 2 second delay\n\n//     return () => clearTimeout(timeoutId);\n//     // Save the change to edit history in MongoDB\n//     // saveEditToHistory(updatedText);\n//   };\n\n//   const handleCopy = (text) => {\n//     navigator.clipboard.writeText(text).then(\n//       () => {\n//         alert(\"Copied to clipboard!\");\n//       },\n//       (err) => {\n//         console.error(\"Failed to copy text:\", err);\n//       }\n//     );\n//   };\n\n//   const handleDownload = (text, filename, format) => {\n//     const blob = new Blob([text], { type: \"text/plain;charset=utf-8\" });\n//     saveAs(blob, `${filename}.${format}`);\n//   };\n\n//   // Fetch document history from database\n//   const fetchDocumentHistory = async () => {\n//     try {\n//       if (!email) return;\n      \n//       const response = await fetch(\n//         `https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/simplifications/user/${email}`\n//       );\n      \n//       if (!response.ok) {\n//         throw new Error(`HTTP error! status: ${response.status}`);\n//       }\n      \n//       const result = await response.json();\n\n//       if (result.data) {\n//         // Group documents by inputText to avoid duplicates\n//         const uniqueDocuments = [];\n//         const inputTextMap = new Map();\n        \n//         result.data.forEach(doc => {\n//           // Use inputText as the key for grouping\n//           if (!inputTextMap.has(doc.inputText)) {\n//             inputTextMap.set(doc.inputText, doc);\n//             uniqueDocuments.push(doc);\n//           } else {\n//             // If we already have this inputText, merge the save history\n//             const existingDoc = inputTextMap.get(doc.inputText);\n            \n//             // Merge edit history if it exists\n//             if (doc.editHistory && doc.editHistory.length > 0) {\n//               existingDoc.editHistory = [...(existingDoc.editHistory || []), ...doc.editHistory];\n//             }\n            \n//             // Merge save history if it exists\n//             if (doc.saveHistory && doc.saveHistory.length > 0) {\n//               existingDoc.saveHistory = [...(existingDoc.saveHistory || []), ...doc.saveHistory];\n//             }\n            \n//             // Update the map with the merged document\n//             inputTextMap.set(doc.inputText, existingDoc);\n//           }\n//         });\n        \n\n//   // useEffect(() => {\n//   //   if (!email) return;\n\n//   //   const fetchDocuments = async () => {\n//   //     try {\n//   //       const response = await fetch(`https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/simplifications/user/${email}`);\n//   //       const result = await response.json();\n\n//   //       if (response.ok) {\n          \n//   //         const sortedDocs = result.data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));\n//   //         setDocuments(sortedDocs);\n//   //         if (sortedDocs.length > 0) {\n//   //           setSelectedDocument(sortedDocs[0]);\n//   //           setSelectedVersion(sortedDocs[0].outputText);\n//   //           setOutputText(sortedDocs[0].outputText);\n//   //         }\n//   //       } else {\n//   //         console.error(\"Error fetching documents:\", result.message);\n//   //       }\n//   //     } catch (error) {\n//   //       console.error(\"Error fetching documents:\", error);\n//   //     }\n//   //   };\n\n//   //   fetchDocuments();\n//   // }, [email]);\n//         // Sort by timestamp\n//         const sortedDocs = [...uniqueDocuments].sort(\n//           (a, b) => new Date(b.createdAt) - new Date(a.createdAt)\n//         );\n        \n//         setDocuments(sortedDocs);\n        \n//         // If first load with no selection, select the first document\n//         if (!selectedDocument && sortedDocs.length > 0) {\n//           handleDocumentClick(sortedDocs[0]);\n//         }\n//       }\n//     } catch (error) {\n//       console.error(\"Error fetching documents:\", error);\n//     }\n//   };\n\n//   const toggleExpandDoc = (docId) => {\n//     setExpandedDocs((prev) => ({\n//       ...prev,\n//       [docId]: !prev[docId],\n//     }));\n//   };\n\n//     // Handle document selection from sidebar\n//     const handleDocumentClick = (doc) => {\n//       setSelectedDocument(doc);\n//       setInputText(doc.inputText);\n//       setOutputText(doc.outputText);\n//       setSelectedVersion(doc.outputText);\n//       setSelectedVersionIndex(0);\n      \n//       // Update diff when document changes\n//       const diffResult = generateDiff(doc.inputText, doc.outputText);\n//       setDiffHtml(diffResult);\n      \n//       // Expand the document in the sidebar\n//       setExpandedDocs(prev => ({\n//         ...prev,\n//         [doc._id]: true\n//       }));\n      \n//       setIsSaveButtonEnabled(false);\n//     };\n\n//   // const handleDocumentClick = (doc) => {\n//   //   setSelectedDocument(doc);\n//   //   setSelectedVersion(doc.outputText);\n//   //   setOutputText(doc.outputText);\n//   //   setSelectedVersionIndex(0);\n//   // };\n//   // Handle version selection from sidebar\n//   const handleVersionChange = (docId, versionIndex) => {\n//     const doc = documents.find(d => d._id === docId);\n//     if (!doc) return;\n\n//     let selectedText;\n//     let sourceText = doc.inputText;\n    \n//     if (versionIndex === 0) {\n//       // Original AI output\n//       selectedText = doc.outputText;\n//     } else if (doc.saveHistory && doc.saveHistory[versionIndex - 1]) {\n//       // Saved version\n//       selectedText = doc.saveHistory[versionIndex - 1].finalText;\n//     } else if (doc.editHistory && doc.editHistory[versionIndex - 1]) {\n//       // Edit history\n//       selectedText = doc.editHistory[versionIndex - 1].text;\n//     } else {\n//       return;\n//     }\n\n//     setSelectedVersion(selectedText);\n//     setOutputText(selectedText);\n//     setSelectedDocument(doc);\n//     setSelectedVersionIndex(Number(versionIndex));\n    \n//     // Update diff with the selected version\n//     const diffResult = generateDiff(sourceText, selectedText);\n//     setDiffHtml(diffResult);\n    \n//     setIsSaveButtonEnabled(false);\n//   };\n\n//   // const handleVersionChange = (docId, versionIndex) => {\n//   //   const doc = documents.find((d) => d._id === docId);\n//   //   if (!doc) return;\n\n//   //   const selectedText =\n//   //     versionIndex === \"0\"\n//   //       ? doc.outputText\n//   //       : doc.saveHistory[versionIndex - 1].finalText;\n\n//   //   setSelectedVersion(selectedText);\n//   //   setOutputText(selectedText);\n//   //   setSelectedDocument(doc);\n//   //   setSelectedVersionIndex(versionIndex);\n//   // };\n\n    \n//   // Initial setup and data loading\n//   useEffect(() => {\n//     if (email) {\n//       fetchDocumentHistory();\n//     }\n    \n//     const savedState = JSON.parse(localStorage.getItem(\"reviewPageState\"));\n//     if (savedState) {\n//       setOutputText(savedState.outputText || \"\");\n//       setEditHistory(savedState.editHistory || []);\n//     } else {\n//       setOutputText(initialOutputText);\n//       setEditHistory(restoredEditHistory || []);\n//     }\n//   }, [email, initialOutputText, restoredEditHistory]);\n\n//   // Save state to localStorage when it changes\n//   useEffect(() => {\n//     const reviewPageState = {\n//       inputText: selectedDocument?.inputText || inputText,\n//       outputText,\n//       editHistory\n//     };\n//     localStorage.setItem(\"reviewPageState\", JSON.stringify(reviewPageState));\n//   }, [outputText, editHistory, inputText, selectedDocument]);\n\n//   // Update word counts when text changes\n//   useEffect(() => {\n//     const { words: inputWords, chars: inputChars } = countWordsAndChars(selectedDocument?.inputText || inputText);\n//     const { words: outputWords, chars: outputChars } = countWordsAndChars(outputText);\n  \n//     setInputWordCount(inputWords);\n//     setInputCharCount(inputChars);\n//     setOutputWordCount(outputWords);\n//     setOutputCharCount(outputChars);\n//   }, [inputText, outputText, selectedDocument]);\n\n//   // Update diff when shown/hidden\n//   useEffect(() => {\n//     if (showDifference) {\n//       const diffResult = generateDiff(selectedDocument?.inputText || inputText, outputText);\n//       setDiffHtml(diffResult);\n//     }\n//   }, [showDifference, inputText, outputText, selectedDocument]);\n\n\n//   // useEffect(() => {\n//   //   const reviewPageState = {\n//   //     inputText,\n//   //     outputText,\n//   //     editHistory,\n//   //   };\n//   //   localStorage.setItem(\"reviewPageState\", JSON.stringify(reviewPageState));\n//   // }, [outputText, editHistory, inputText]);\n  \n//   // useEffect(() => {\n//   //   const savedState = JSON.parse(localStorage.getItem(\"reviewPageState\"));\n//   //   if (savedState) {\n//   //     setOutputText(savedState.outputText || \"\");\n//   //     setEditHistory(savedState.editHistory || []);\n//   //   } else {\n//   //     setOutputText(initialOutputText);\n//   //     setEditHistory(restoredEditHistory || []);\n//   //   }\n  \n//   //   if (!localStorage.getItem(\"initialAIOutput\")) {\n//   //     localStorage.setItem(\"initialAIOutput\", initialOutputText);\n//   //   }\n\n//   //  saveSimplification(); // Save the initial inputText and outputText\n//   //   setIsSaveButtonEnabled(true);\n//   // }, [initialOutputText, restoredEditHistory]);\n  \n\n//   // useEffect(() => {\n//   //   const diffResult = generateDiff(inputText, outputText);\n//   //   setDiffHtml(diffResult);\n//   //  // saveSimplification();\n//   // }, [inputText, outputText]);\n\n//   // useEffect(() => {\n//   //   saveSimplification(); \n//   //   setIsSaveButtonEnabled(true);\n\n//   //   const savedState = JSON.parse(localStorage.getItem(\"reviewPageState\"));\n//   //   if (savedState) {\n//   //     setOutputText(savedState.outputText || \"\");\n//   //     setEditHistory(savedState.editHistory || []);\n//   //   }\n//   // }, []);\n  \n//   // useEffect(() => {\n//   //   const { words: inputWords, chars: inputChars } = countWordsAndChars(inputText);\n//   //   const { words: outputWords, chars: outputChars } = countWordsAndChars(outputText);\n  \n//   //   setInputWordCount(inputWords);\n//   //   setInputCharCount(inputChars);\n//   //   setOutputWordCount(outputWords);\n//   //   setOutputCharCount(outputChars);\n//   // }, [inputText, outputText]);\n\n  \n//   const handleHistoryClick = (edit) => {\n//     setOutputText(edit.text);\n//     const diffResult = generateDiff(inputText, edit.text);\n//     setDiffHtml(diffResult);\n//     setIsEditable(false);\n//   };\n\n\n//   return (\n//     <>\n//       <nav className={styles.navbar}>\n//         {/* <h1>Text Simplification Tool</h1> */}\n//         <h1 \n//     onClick={() => window.location.href = \"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/\"}\n//     style={{ cursor: \"pointer\" }} // Makes it look clickable\n//  \t\t>\n// \t\tText Simplification Tool</h1>\n//         <button className={styles.white_btn} onClick={handleLogout}>\n//           Logout\n//         </button>\n//       </nav>\n\n//       <div className={styles.container}>\n//         {/* Sidebar */}\n//         <div\n//           className={`${styles.sidebar} ${\n//             isSidebarVisible ? styles.expanded : \"\"\n//           }`}\n//         >\n//           <button\n//             className={styles.historyIcon}\n//             onClick={() => setIsSidebarVisible(!isSidebarVisible)}\n//           >\n//              ðŸ•’   <p style={{ fontSize: \"15px\" }}> History </p> \n//           </button>\n\n//         {isSidebarVisible && (\n//             <div className={styles.historyContent}>\n//               <button className={styles.closeButton} onClick={() => setIsSidebarVisible(false)}>âœ–</button>\n//               <ul className={styles.historyList}>\n//                 {documents.map((doc, index) => (\n//                   <li key={doc._id} className={styles.historyItem}>\n//                     {/* <div onClick={() => toggleExpandDoc(doc._id)} className={styles.docHeader}> */}\n//                     <div\n//                       // onClick={() => toggleExpandDoc(doc._id)}\n//                       onClick={() => {\n//                         toggleExpandDoc(doc._id);\n//                         handleDocumentClick(doc);\n//                       }}\n//                       className={`${styles.docHeader} ${selectedDocument?._id === doc._id ? styles.activeDoc : \"\"}`}\n//                     >\n\n//                       {/* <strong>Document {index + 1}</strong>  */}\n//                       <strong>Document {documents.length - index}</strong> ({doc.inputText.substring(0, 20)}..., {new Date(doc.createdAt).toLocaleDateString()})\n//                     </div>\n\n//                     {expandedDocs[doc._id] && (\n//                       <ul className={styles.versionList}>\n//                         <li key=\"0\" onClick={() => handleVersionChange(doc._id, 0)} className={selectedVersionIndex === 0 && selectedDocument?._id === doc._id ? styles.activeVersion : \"\"}>\n//                           Version 1 (Generated Text)\n//                         </li>\n//                         {doc.saveHistory && doc.saveHistory.map((version, vIndex) => (\n//                           <li\n//                             key={vIndex + 1}\n//                             onClick={() => handleVersionChange(doc._id, vIndex + 1)}\n//                             className={selectedVersionIndex === vIndex + 1 && selectedDocument?._id === doc._id ? styles.activeVersion : \"\"}\n//                           >\n//                             Version {vIndex + 2} (Saved on {new Date(version.timestamp).toLocaleDateString()})\n//                           </li>\n//                         ))}\n//                       </ul>\n//                     )}\n//                   </li>\n//                 ))}\n//               </ul>\n//             </div>\n//           )}\n//         {/* <div className={styles.versionSelector}>\n//           <label>Select Version:</label>\n//           <select onChange={handleVersionChange} value={documents.indexOf(selectedDocument)}>\n//             <option value=\"0\">Version 1 (Generated Text)</option>\n//             {selectedDocument?.saveHistory.map((version, index) => (\n//               <option key={index + 1} value={index + 1}>\n//                 Version {index + 2} (Saved on {new Date(version.timestamp).toLocaleDateString()})\n//               </option>\n//             ))}\n//           </select>\n//         </div> */}\n\n//         </div>\n\n//         {/* Main Content */}\n//         <div\n//           className={`${styles.mainContent} ${\n//             isSidebarVisible ? styles.withSidebar : \"\"\n//           }`}\n//         >\n// \t\t\t<div className={styles.description}>\n// \t\t\t<p>\n\t\n//         Please review the simplified text carefully and if needed, correct/edit it to suit your requirements. Once you are satisfied with your revisions, save the final version and complete the short survey to provide your feedback.\n//       </p>\n// \t\t\t</div>\n\n// \t\t\t<div className={styles.textareas_container}>\n\n//   {/* Input Text */}\n//   <div className={styles.text_container}>\n//     <div className={styles.labelWrapper}>\n//       <label className={styles.label} htmlFor=\"inputText\">\n//         Input Text\n//       </label>\n//       <div className={styles.actions}>\n//       <div\n//         className={styles.copyIcon}\n//         onClick={() => handleCopy(inputText)}\n//         title=\"Copy to Clipboard\"\n//       >\n        \n//         ðŸ“‹ {/* Clipboard Emoji */}\n//         </div>\n\n//         <div\n//         className={styles.copyIcon}\n//         onClick={() => handleDownload(inputText, \"InputText\", \"txt\")}\n//         title=\"Download as .txt file\"\n//       >\n//         ðŸ“¥ {/* Download Icon */}\n//       </div>\n\n//             {/* New Re-simplify Button */}\n//       <div\n//         className={styles.copyIcon}\n//         onClick={handleResimplify}\n//         title=\"Re-simplify Text\"\n//         style={{ cursor: isLoading ? \"not-allowed\" : \"pointer\", opacity: isLoading ? 0.6 : 1 }}\n//         >\n//           {isLoading ? \"âŒ›\" : \"ðŸ”„\"}\n\n//       </div>\n\n//       </div>\n//     </div>\n//     <p className={styles.countText}>Words: {inputWordCount} | Characters: {inputCharCount}</p>\n//     {/* <textarea id=\"inputText\" className={styles.textarea} value={selectedDocument?.inputText || \"\"} readOnly></textarea> */}\n\n//     <textarea\n//       id=\"inputText\"\n//       className={`${styles.textarea} ${styles.side_by_side}`}\n//       value={selectedDocument?.inputText || inputText}\n//       readOnly\n//     ></textarea>\n//   </div>\n\n// \t\t\t{/* Output Text Box */}\n// <div className={styles.text_container}>\n//   <div className={styles.labelWrapper}>\n//     <label className={styles.label} htmlFor=\"outputText\">\n//       AI-generated Text\n//     </label>\n//     <div className={styles.actions}>\n//       <div\n//         className={styles.copyIcon}\n//         onClick={() => handleCopy(outputText)}\n//         title=\"Copy to Clipboard\"\n//       >\n//         ðŸ“‹ {/* Clipboard Emoji */}\n//       </div>\n\n//       <div\n//         className={styles.copyIcon}\n//         onClick={() => handleDownload(outputText, \"GeneratedText\", \"txt\")}\n//         title=\"Download as .txt file\"\n//       >\n//         ðŸ“¥ {/* Download Icon */}\n//       </div>\n//       <button\n//         className={styles.toggleDiffBtn}\n//         onClick={() => setShowDifference(!showDifference)}\n//       >\n//         {showDifference ? \"Hide Difference with input text\" : \"Show Difference with input text\"}\n//       </button>\n//     </div>\n//   </div>\n//     {/* Word and Character Count */}\n//     <p className={styles.countText}>Words: {outputWordCount} | Characters: {outputCharCount}</p>\n\n//   <textarea\n//     id=\"outputText\"\n//     className={`${styles.output_box} ${styles.side_by_side}`}\n//     value={outputText}\n//     onChange={handleEditChange}\n//     readOnly={isEditable}\n//     placeholder=\"Output\"\n\n//   ></textarea>\n\n//   {/* <div\n//     ref={contentEditableRef}\n//     contentEditable={!isEditable}\n//     className={`${styles.output_box} ${styles.side_by_side} ${styles.editableDiv}`}\n//     onInput={(e) => handleLiveEdit(e)}\n//     dangerouslySetInnerHTML={{ __html: diffHtml }}\n//   ></div> */}\n\n// </div>\n\n//             {/* Difference Text */}\n// \t\t\t{showDifference && (\n// \t\t\t\t<div className={styles.text_container}>\n//           <div className={styles.labelWrapper}>\n//             <label className={styles.label} htmlFor=\"diffText\">\n//               Difference from input text\n//             </label>\n//           </div>   \n         \n// \t\t\t\t\t<div\n//             id=\"diffText\"\n//             className={`${styles.output_box} ${styles.side_by_side}`}\n//             dangerouslySetInnerHTML={{ __html: diffHtml }}\n// \t\t\t\t\t>\n//           </div>\n// \t\t\t\t {/* )} */}\n// \t\t\t\t</div>\n// \t\t\t)}\n\t\t\t\n// \t\t\t</div>\n\n\n\n//           {/* Buttons */}\n// \t\t\t<div className={styles.button_container}>\n\n    \n//     \t\t\t\t{/* <button\n//     \t\t\t\t\tclassName={`${styles.save_btn} ${styles.text_btn}`}\n//               onClick={saveFinalOutput}\n//               disabled={!isSaveButtonEnabled || isLoading}\n//               title={!isSaveButtonEnabled ? \"Please make an edit before submitting.\" : \"\"}\n\n//     \t\t\t\t>\n//     \t\t\t\t\tSubmit\n//     \t\t\t\t</button> */}\n\n//             <button\n//             className={styles.submit_btn}\n//             onClick={saveFinalOutput}\n//             disabled={!isSaveButtonEnabled || isLoading}\n//             title={!isSaveButtonEnabled ? \"Please make an edit before saving again.\" : \"\"}\n//             >\n//                           {isLoading ? \"Saving...\" : \"Save\"}\n\n//             </button>\n//       </div>\n\n//   {/* Survey Prompt (Appears Only After Submitting) */}\n//   {showSurveyPrompt && (\n//     <div className={styles.survey_prompt} ref={surveyRef}>\n//       <p className={styles.survey_text}>\n//         Please take the survey to help us improve.\n//         <button\n//           className={styles.survey_btn}\n//           onClick={() => {\n//             // const currentOutput = document.getElementById(\"outputText\")?.value;\n//             // const initialAIOutput = localStorage.getItem(\"initialAIOutput\") || initialOutputText;\n//             const currentOutput = outputText;\n//             const initialAIOutput = selectedDocument?.outputText || initialOutputText;\n            \n//             navigate(\"/survey\", {\n//               state: {\n//                 email: email,\n//                 inputText: selectedDocument?.inputText || inputText,\n//                 outputText: initialAIOutput,\n//                 editHistory,\n//                 saveHistory: [\n//                   ...(saveHistory || []), \n//                   { \n//                     timestamp: new Date().toISOString(), \n//                     finalText: currentOutput \n//                   }\n//                 ],\n//               },\n//             });\n//           }}\n//         >\n//             {/* // const reviewPageState = { inputText, outputText: currentOutput, editHistory, saveHistory };\n//             // localStorage.setItem(\"reviewPageState\", JSON.stringify(reviewPageState));\n\n//             navigate(\"/survey\", {\n//               state: {\n//                 email: JSON.parse(localStorage.getItem(\"user\")).email,\n//                 inputText,\n//                 outputText: initialAIOutput,\n//                 editHistory,\n//                 saveHistory: [...saveHistory, { timestamp: new Date().toISOString(), finalText: currentOutput }],\n//               },\n//             });\n//           }}\n//         > */}\n//           ðŸ“‘ Take the Survey\n//         </button>\n//       </p>\n//     </div>\n//   )}\n\n// <p className={styles.help_text}>Need Help? <a href=\"mailto:anukumar@uw.edu\">Contact Support</a></p>\n\n\n\n\n//         </div>\n//       </div>\n//     </>\n//   );\n// };\n\n// export default Review;\nimport React, { useState, useEffect, useRef } from \"react\";\nimport { useLocation, useNavigate } from \"react-router-dom\";\nimport DiffMatchPatch from \"diff-match-patch\";\nimport { FaRegCopy, FaDownload } from \"react-icons/fa\";\nimport { saveAs } from \"file-saver\";\nimport styles from \"./styles.module.css\";\n\nconst Review = () => {\n  const { state } = useLocation();\n  const initialState = state || {\n    inputText: \"\",\n    outputText: \"\",\n    editHistory: []\n  };\n\n  // Use initial values from location state\n  const [inputText, setInputText] = useState(initialState.inputText);\n  const [outputText, setOutputText] = useState(initialState.outputText);\n  const [editHistory, setEditHistory] = useState(initialState.editHistory || []);\n  const [saveHistory, setSaveHistory] = useState([]);\n  const [showDifference, setShowDifference] = useState(false);\n  const [diffHtml, setDiffHtml] = useState(\"\");\n  const [isSaveButtonEnabled, setIsSaveButtonEnabled] = useState(false);\n  const [isLoading, setIsLoading] = useState(false);\n  const [showSurveyPrompt, setShowSurveyPrompt] = useState(false);\n  const [isSidebarVisible, setIsSidebarVisible] = useState(false);\n\n  // Document selection states\n  const [documents, setDocuments] = useState([]);\n  const [selectedDocument, setSelectedDocument] = useState(null);\n  const [selectedVersion, setSelectedVersion] = useState(null);\n  const [selectedVersionIndex, setSelectedVersionIndex] = useState(0);\n  const [expandedDocs, setExpandedDocs] = useState({});\n  \n  // Word count states\n  const [inputWordCount, setInputWordCount] = useState(0);\n  const [inputCharCount, setInputCharCount] = useState(0);\n  const [outputWordCount, setOutputWordCount] = useState(0);\n  const [outputCharCount, setOutputCharCount] = useState(0);\n  \n  const navigate = useNavigate();\n  const surveyRef = useRef(null);\n  \n  // Safely get user from localStorage\n  const getUserEmail = () => {\n    try {\n      const user = JSON.parse(localStorage.getItem(\"user\"));\n      return user?.email || \"\";\n    } catch (error) {\n      console.error(\"Failed to parse user from localStorage:\", error);\n      return \"\";\n    }\n  };\n\n  const email = getUserEmail();\n\n  // Count words and characters\n  const countWordsAndChars = (text) => {\n    if (!text) return { words: 0, chars: 0 };\n    const words = text.trim().split(/\\s+/).filter(Boolean).length;\n    const chars = text.length;\n    return { words, chars };\n  };\n\n  // Generate difference between texts\n  const generateDiff = (input, output) => {\n    if (!input || !output) return \"\";\n    \n    const dmp = new DiffMatchPatch();\n    const diffs = dmp.diff_main(input, output);\n    dmp.diff_cleanupSemantic(diffs);\n  \n    const html = diffs\n      .map(([op, text]) => {\n        if (op === DiffMatchPatch.DIFF_INSERT) {\n          return `<span style=\"background-color: #d4fcdc; color: green;\">${text}</span>`;\n        } else if (op === DiffMatchPatch.DIFF_DELETE) {\n          return `<span style=\"background-color: #ffecec; color: red; text-decoration: line-through;\">${text}</span>`;\n        } else {\n          return `<span>${text}</span>`;\n        }\n      })\n      .join(\"\");\n  \n    return html;\n  };\n\n  // Handle user logout\n  const handleLogout = () => {\n    localStorage.removeItem(\"token\");\n    localStorage.removeItem(\"reviewPageState\");\n    navigate(\"/Login\");\n  };\n\n  // Handle re-simplify request\n  const handleResimplify = async () => {\n    if (!inputText.trim()) return;\n  \n    setIsLoading(true);\n  \n    try {\n      const generatePrompt = (text) => `\n        You are an expert in accessible communication, tasked with transforming complex text into clear, accessible plain language for individuals with Intellectual and Developmental Disabilities (IDD) or those requiring simplified content. Retain all essential information and intent while prioritizing readability, comprehension, and inclusivity.\n        \n        Text simplification refers to rewriting or adapting text to make it easier to read and understand while keeping the same level of detail and precision. Make sure you focus on simplification and not summarization. The length of generated output text must be similar to that of input text.\n        \n        Guidelines for Simplification:\n        Vocabulary and Terminology:\n        Replace uncommon, technical, or abstract words with simple, everyday language.\n        Define unavoidable complex terms in plain language within parentheses upon first use (example: \"cardiologist (heart doctor)\").\n        Avoid idioms, metaphors, sarcasm, or culturally specific references.\n        \n        Sentence Structure:\n        Use short sentences (10-15 words max). Break long sentences into 1â€“2 ideas each.\n        Prefer active voice (example: \"The doctor examined the patient\" vs. \"The patient was examined by the doctor\").\n        Avoid nested clauses, passive voice, and ambiguous pronouns (example: \"they,\" \"it\").\n        \n        \"${text}\"`;\n      \n      const splitTextIntoChunks = (text, maxTokens) => {\n        const words = text.split(/\\s+/);\n        let chunks = [];\n        let currentChunk = [];\n      \n        for (let word of words) {\n          if (currentChunk.join(\" \").length + word.length < maxTokens) {\n            currentChunk.push(word);\n          } else {\n            chunks.push(currentChunk.join(\" \"));\n            currentChunk = [word];\n          }\n        }\n        \n        if (currentChunk.length > 0) chunks.push(currentChunk.join(\" \"));\n        return chunks;\n      };\n      \n      // Use either the selected document's input text or the current inputText state\n      const textToSimplify = selectedDocument?.inputText || inputText;\n      const chunks = splitTextIntoChunks(textToSimplify, 10000);\n      let combinedOutput = \"\";\n    \n      for (let chunk of chunks) {\n        const prompt = generatePrompt(chunk);\n        const response = await fetch(\"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/gpt4\", {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ prompt }),\n        });\n      \n        if (!response.ok) {\n          console.error(\"Error with API request:\", response.status);\n          continue; // Skip this chunk if the API request failed\n        }\n  \n        const data = await response.json();\n        const newOutput = data?.response?.replace(/^\"|\"$/g, \"\") || \"No response received.\";\n        combinedOutput += newOutput + \" \";\n      }\n      \n      setOutputText(combinedOutput.trim());\n      \n      // Update diff when output text changes\n      const diffResult = generateDiff(textToSimplify, combinedOutput.trim());\n      setDiffHtml(diffResult);\n      \n      setIsSaveButtonEnabled(true);\n    } catch (error) {\n      console.error(\"Error fetching GPT-4o response:\", error);\n      alert(\"An error occurred while simplifying the text. Please try again.\");\n    }\n  \n    setIsLoading(false);\n  };\n\n  // Save edit to history in database\n  const saveEditToHistory = async (editedText) => {\n    try {\n      if (!email) {\n        console.error(\"User email not found, cannot save edit\");\n        return;\n      }\n\n      const numWords = editedText.trim().split(/\\s+/).filter(Boolean).length;\n      const numChars = editedText.length;\n\n      const response = await fetch(\"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/simplifications/edit\", {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          email,\n          inputText: selectedDocument?.inputText || inputText,\n          editedText,\n          numWords,\n          numChars\n        }),\n      });\n\n      if (response.ok) {\n        console.log(\"Edit saved to history.\");\n        // Refresh documents after saving edit\n        fetchDocumentHistory();\n      } else {\n        const error = await response.json();\n        console.error(\"Error saving edit to history:\", error.message);\n      }\n    } catch (error) {\n      console.error(\"Error saving edit to history:\", error);\n    }\n  };\n\n  // Save final output to database\n  const saveFinalOutput = async () => {\n    setIsLoading(true);\n\n    try {\n      if (!email) {\n        alert(\"User information not found. Please log in again.\");\n        navigate(\"/login\");\n        return;\n      }\n\n      const numWords = outputText.trim().split(/\\s+/).filter(Boolean).length;\n      const numChars = outputText.length;\n      \n      const response = await fetch(\"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/simplifications/save\", {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          email,\n          inputText: selectedDocument?.inputText || inputText,\n          finalText: outputText,\n          numWords,\n          numChars\n        }),\n      });\n\n      const timestamp = new Date().toISOString();\n      setEditHistory((prev) => [\n        ...prev,\n        { timestamp, text: outputText }\n      ]);\n\n      if (response.ok) {\n        console.log(\"Final output saved successfully.\");\n        setIsSaveButtonEnabled(false);\n        setShowSurveyPrompt(true);\n\n        // Automatically scroll to survey prompt\n        setTimeout(() => {\n          if (surveyRef.current) {\n            surveyRef.current.scrollIntoView({ behavior: \"smooth\", block: \"center\" });\n          }\n        }, 300);\n\n        setSaveHistory((prev) => [...prev, { timestamp, finalText: outputText }]);\n        \n        // Refresh documents after saving\n        fetchDocumentHistory();\n      } else {\n        const error = await response.json();\n        console.error(\"Error saving final output:\", error.message);\n        alert(\"Error saving your changes. Please try again.\");\n      }\n    } catch (error) {\n      console.error(\"Error saving final output:\", error);\n      alert(\"Error saving your changes. Please try again.\");\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  // Handle edit changes\n  const handleEditChange = (event) => {\n    const updatedText = event.target.value;\n    setOutputText(updatedText);\n    setIsSaveButtonEnabled(true);\n    \n    // Update diff when output text changes\n    const diffResult = generateDiff(selectedDocument?.inputText || inputText, updatedText);\n    setDiffHtml(diffResult);\n\n    // Save the change to edit history in MongoDB after a delay (debouncing)\n    const timeoutId = setTimeout(() => {\n      saveEditToHistory(updatedText);\n    }, 2000); // 2 second delay\n\n    return () => clearTimeout(timeoutId);\n  };\n\n  // Copy text to clipboard\n  const handleCopy = (text) => {\n    navigator.clipboard.writeText(text).then(\n      () => {\n        alert(\"Copied to clipboard!\");\n      },\n      (err) => {\n        console.error(\"Failed to copy text:\", err);\n      }\n    );\n  };\n\n  // Download text as file\n  const handleDownload = (text, filename, format) => {\n    const blob = new Blob([text], { type: \"text/plain;charset=utf-8\" });\n    saveAs(blob, `${filename}.${format}`);\n  };\n\n  // Fetch document history from database\n  const fetchDocumentHistory = async () => {\n    if (!email) {\n      console.log(\"Email not available, skipping document history fetch\");\n      return;\n    }\n    \n    try {\n      const response = await fetch(\n        `https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/api/simplifications/user/${email}`\n      );\n      \n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`);\n      }\n      \n      const result = await response.json();\n\n      if (result.data) {\n        // Group documents by inputText to avoid duplicates\n        const uniqueDocuments = [];\n        const inputTextMap = new Map();\n        \n        result.data.forEach(doc => {\n          // Use inputText as the key for grouping\n          if (!inputTextMap.has(doc.inputText)) {\n            inputTextMap.set(doc.inputText, doc);\n            uniqueDocuments.push(doc);\n          } else {\n            // If we already have this inputText, merge the save history\n            const existingDoc = inputTextMap.get(doc.inputText);\n            \n            // Merge edit history if it exists\n            if (doc.editHistory && doc.editHistory.length > 0) {\n              existingDoc.editHistory = [...(existingDoc.editHistory || []), ...doc.editHistory];\n            }\n            \n            // Merge save history if it exists\n            if (doc.saveHistory && doc.saveHistory.length > 0) {\n              existingDoc.saveHistory = [...(existingDoc.saveHistory || []), ...doc.saveHistory];\n            }\n            \n            // Update the map with the merged document\n            inputTextMap.set(doc.inputText, existingDoc);\n          }\n        });\n        \n        // Sort by timestamp\n        const sortedDocs = [...uniqueDocuments].sort(\n          (a, b) => new Date(b.createdAt) - new Date(a.createdAt)\n        );\n        \n        setDocuments(sortedDocs);\n        \n        // If first load with no selection, select the first document\n        if (!selectedDocument && sortedDocs.length > 0) {\n          handleDocumentClick(sortedDocs[0]);\n        }\n      }\n    } catch (error) {\n      console.error(\"Error fetching documents:\", error);\n    }\n  };\n\n  // Toggle document expansion in sidebar\n  const toggleExpandDoc = (docId) => {\n    setExpandedDocs(prev => ({\n      ...prev,\n      [docId]: !prev[docId]\n    }));\n  };\n\n  // Handle document selection from sidebar\n  const handleDocumentClick = (doc) => {\n    setSelectedDocument(doc);\n    setInputText(doc.inputText); // Important: update the inputText state\n    setOutputText(doc.outputText);\n    setSelectedVersion(doc.outputText);\n    setSelectedVersionIndex(0);\n    \n    // Update diff when document changes\n    const diffResult = generateDiff(doc.inputText, doc.outputText);\n    setDiffHtml(diffResult);\n    \n    // Expand the document in the sidebar\n    setExpandedDocs(prev => ({\n      ...prev,\n      [doc._id]: true\n    }));\n    \n    setIsSaveButtonEnabled(false);\n  };\n\n  // Handle version selection from sidebar\n  const handleVersionChange = (docId, versionIndex) => {\n    const doc = documents.find(d => d._id === docId);\n    if (!doc) return;\n\n    let selectedText;\n    let sourceText = doc.inputText;\n    \n    if (versionIndex === 0) {\n      // Original AI output\n      selectedText = doc.outputText;\n    } else if (doc.saveHistory && doc.saveHistory[versionIndex - 1]) {\n      // Saved version\n      selectedText = doc.saveHistory[versionIndex - 1].finalText;\n    } else if (doc.editHistory && doc.editHistory[versionIndex - 1]) {\n      // Edit history\n      selectedText = doc.editHistory[versionIndex - 1].text;\n    } else {\n      return;\n    }\n\n    setSelectedVersion(selectedText);\n    setOutputText(selectedText);\n    setSelectedDocument(doc);\n    setInputText(doc.inputText); // Update inputText state when version changes\n    setSelectedVersionIndex(Number(versionIndex));\n    \n    // Update diff with the selected version\n    const diffResult = generateDiff(sourceText, selectedText);\n    setDiffHtml(diffResult);\n    \n    setIsSaveButtonEnabled(false);\n  };\n\n  // Initial setup and data loading\n  useEffect(() => {\n    if (email) {\n      fetchDocumentHistory();\n    }\n    \n    const savedState = JSON.parse(localStorage.getItem(\"reviewPageState\"));\n    if (savedState) {\n      setInputText(savedState.inputText || \"\");\n      setOutputText(savedState.outputText || \"\");\n      setEditHistory(savedState.editHistory || []);\n    } else if (initialState.inputText) {\n      // Initialize from location state if available\n      setInputText(initialState.inputText);\n      setOutputText(initialState.outputText);\n      setEditHistory(initialState.editHistory || []);\n    }\n  }, [email, initialState.inputText, initialState.outputText, initialState.editHistory]);\n\n  // Save state to localStorage when it changes\n  useEffect(() => {\n    const reviewPageState = {\n      inputText: selectedDocument?.inputText || inputText,\n      outputText,\n      editHistory\n    };\n    localStorage.setItem(\"reviewPageState\", JSON.stringify(reviewPageState));\n  }, [outputText, editHistory, inputText, selectedDocument]);\n\n  // Update word counts when text changes\n  useEffect(() => {\n    const { words: inputWords, chars: inputChars } = countWordsAndChars(selectedDocument?.inputText || inputText);\n    const { words: outputWords, chars: outputChars } = countWordsAndChars(outputText);\n  \n    setInputWordCount(inputWords);\n    setInputCharCount(inputChars);\n    setOutputWordCount(outputWords);\n    setOutputCharCount(outputChars);\n  }, [inputText, outputText, selectedDocument]);\n\n  // Update diff when shown/hidden\n  useEffect(() => {\n    if (showDifference) {\n      const diffResult = generateDiff(selectedDocument?.inputText || inputText, outputText);\n      setDiffHtml(diffResult);\n    }\n  }, [showDifference, inputText, outputText, selectedDocument]);\n\n  return (\n    <>\n      <nav className={styles.navbar}>\n        <h1 \n          onClick={() => window.location.href = \"https://textsimplification-eecqhvdcduczf8cz.westus-01.azurewebsites.net/\"}\n          style={{ cursor: \"pointer\" }}\n        >\n          Text Simplification Tool\n        </h1>\n        <button className={styles.white_btn} onClick={handleLogout}>\n          Logout\n        </button>\n      </nav>\n\n      <div className={styles.container}>\n        {/* Sidebar */}\n        <div\n          className={`${styles.sidebar} ${\n            isSidebarVisible ? styles.expanded : \"\"\n          }`}\n        >\n          <button\n            className={styles.historyIcon}\n            onClick={() => setIsSidebarVisible(!isSidebarVisible)}\n          >\n            ðŸ•’ <p style={{ fontSize: \"15px\" }}>History</p>\n          </button>\n\n          {isSidebarVisible && (\n            <div className={styles.historyContent}>\n              <button className={styles.closeButton} onClick={() => setIsSidebarVisible(false)}>âœ–</button>\n              <ul className={styles.historyList}>\n                {documents.map((doc, index) => (\n                  <li key={doc._id} className={styles.historyItem}>\n                    <div\n                      onClick={() => {\n                        toggleExpandDoc(doc._id);\n                        handleDocumentClick(doc);\n                      }}\n                      className={`${styles.docHeader} ${selectedDocument?._id === doc._id ? styles.activeDoc : \"\"}`}\n                    >\n                      <strong>Document {documents.length - index}</strong>\n                      <span className={styles.docPreview}>\n                        ({doc.inputText.substring(0, 20)}...)\n                      </span>\n                      <span className={styles.docDate}>\n                        {new Date(doc.createdAt).toLocaleDateString()}\n                      </span>\n                    </div>\n\n                    {expandedDocs[doc._id] && (\n                      <ul className={styles.versionList}>\n                        <li \n                          key=\"0\" \n                          onClick={() => handleVersionChange(doc._id, 0)} \n                          className={selectedVersionIndex === 0 && selectedDocument?._id === doc._id ? styles.activeVersion : \"\"}\n                        >\n                          Version 1 (Generated Text)\n                        </li>\n                        {doc.saveHistory && doc.saveHistory.map((version, vIndex) => (\n                          <li\n                            key={`save-${vIndex}`}\n                            onClick={() => handleVersionChange(doc._id, vIndex + 1)}\n                            className={selectedVersionIndex === vIndex + 1 && selectedDocument?._id === doc._id ? styles.activeVersion : \"\"}\n                          >\n                            Version {vIndex + 2} (Saved on {new Date(version.timestamp).toLocaleDateString()})\n                          </li>\n                        ))}\n                      </ul>\n                    )}\n                  </li>\n                ))}\n              </ul>\n            </div>\n          )}\n        </div>\n\n        {/* Main Content */}\n        <div\n          className={`${styles.mainContent} ${\n            isSidebarVisible ? styles.withSidebar : \"\"\n          }`}\n        >\n          <div className={styles.description}>\n            <p>\n              Please review the simplified text carefully and if needed, correct/edit it to suit your requirements. \n              Once you are satisfied with your revisions, save the final version and complete the short survey to provide your feedback.\n            </p>\n          </div>\n\n          <div className={styles.textareas_container}>\n            {/* Input Text */}\n            <div className={styles.text_container}>\n              <div className={styles.labelWrapper}>\n                <label className={styles.label} htmlFor=\"inputText\">\n                  Input Text\n                </label>\n                <div className={styles.actions}>\n                  <div\n                    className={styles.copyIcon}\n                    onClick={() => handleCopy(selectedDocument?.inputText || inputText)}\n                    title=\"Copy to Clipboard\"\n                  >\n                    ðŸ“‹\n                  </div>\n\n                  <div\n                    className={styles.copyIcon}\n                    onClick={() => handleDownload(selectedDocument?.inputText || inputText, \"InputText\", \"txt\")}\n                    title=\"Download as .txt file\"\n                  >\n                    ðŸ“¥\n                  </div>\n\n                  <div\n                    className={styles.copyIcon}\n                    onClick={handleResimplify}\n                    title=\"Re-simplify Text\"\n                    style={{ cursor: isLoading ? \"not-allowed\" : \"pointer\", opacity: isLoading ? 0.6 : 1 }}\n                  >\n                    {isLoading ? \"âŒ›\" : \"ðŸ”„\"}\n                  </div>\n                </div>\n              </div>\n              <p className={styles.countText}>Words: {inputWordCount} | Characters: {inputCharCount}</p>\n\n              <textarea\n                id=\"inputText\"\n                className={`${styles.textarea} ${styles.side_by_side}`}\n                value={selectedDocument?.inputText || inputText}\n                readOnly\n              ></textarea>\n            </div>\n\n            {/* Output Text Box */}\n            <div className={styles.text_container}>\n              <div className={styles.labelWrapper}>\n                <label className={styles.label} htmlFor=\"outputText\">\n                  AI-generated Text\n                </label>\n                <div className={styles.actions}>\n                  <div\n                    className={styles.copyIcon}\n                    onClick={() => handleCopy(outputText)}\n                    title=\"Copy to Clipboard\"\n                  >\n                    ðŸ“‹\n                  </div>\n\n                  <div\n                    className={styles.copyIcon}\n                    onClick={() => handleDownload(outputText, \"GeneratedText\", \"txt\")}\n                    title=\"Download as .txt file\"\n                  >\n                    ðŸ“¥\n                  </div>\n                  <button\n                    className={styles.toggleDiffBtn}\n                    onClick={() => setShowDifference(!showDifference)}\n                  >\n                    {showDifference ? \"Hide Difference with input text\" : \"Show Difference with input text\"}\n                  </button>\n                </div>\n              </div>\n              <p className={styles.countText}>Words: {outputWordCount} | Characters: {outputCharCount}</p>\n\n              <textarea\n                id=\"outputText\"\n                className={`${styles.output_box} ${styles.side_by_side}`}\n                value={outputText}\n                onChange={handleEditChange}\n                placeholder=\"Output\"\n              ></textarea>\n            </div>\n\n            {/* Difference Text */}\n            {showDifference && (\n              <div className={styles.text_container}>\n                <div className={styles.labelWrapper}>\n                  <label className={styles.label} htmlFor=\"diffText\">\n                    Difference from input text\n                  </label>\n                </div>\n                <div\n                  id=\"diffText\"\n                  className={`${styles.output_box} ${styles.side_by_side}`}\n                  dangerouslySetInnerHTML={{ __html: diffHtml }}\n                ></div>\n              </div>\n            )}\n          </div>\n\n          {/* Buttons */}\n          <div className={styles.button_container}>\n            <button\n              className={styles.submit_btn}\n              onClick={saveFinalOutput}\n              disabled={!isSaveButtonEnabled || isLoading}\n              title={!isSaveButtonEnabled ? \"Please make an edit before saving again.\" : \"\"}\n            >\n              {isLoading ? \"Saving...\" : \"Save\"}\n            </button>\n          </div>\n\n          {/* Survey Prompt (Appears Only After Submitting) */}\n          {showSurveyPrompt && (\n            <div className={styles.survey_prompt} ref={surveyRef}>\n              <p className={styles.survey_text}>\n                Please take the survey to help us improve.\n                <button\n                  className={styles.survey_btn}\n                  onClick={() => {\n                    const currentOutput = outputText;\n                    const initialAIOutput = selectedDocument?.outputText || initialState.outputText;\n                    \n                    navigate(\"/survey\", {\n                      state: {\n                        email: email,\n                        inputText: selectedDocument?.inputText || inputText,\n                        outputText: initialAIOutput,\n                        editHistory,\n                        saveHistory: [\n                          ...(saveHistory || []), \n                          { \n                            timestamp: new Date().toISOString(), \n                            finalText: currentOutput \n                          }\n                        ],\n                      },\n                    });\n                  }}\n                >\n                  ðŸ“‘ Take the Survey\n                </button>\n              </p>\n            </div>\n          )}\n\n          <p className={styles.help_text}>Need Help? <a href=\"mailto:anukumar@uw.edu\">Contact Support</a></p>\n        </div>\n      </div>\n    </>\n  );\n};\n\nexport default Review;"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAGA;AACA;AACA;AAGA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAIA;AAGA;AACA;AAGA;AAEA;AACA;AAEA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAGA;AACA;AACA;AAEA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AAGA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAGA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAKA;AACA;AAEA;AAEA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAGA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AAGA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAGA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAIA;AACA;AAGA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAKA;AACA;AACA;AACA;AACA;AAEA;AACA,MAAO,CAAAA,KAAK,EAAIC,QAAQ,CAAEC,SAAS,CAAEC,MAAM,KAAQ,OAAO,CAC1D,OAASC,WAAW,CAAEC,WAAW,KAAQ,kBAAkB,CAC3D,MAAO,CAAAC,cAAc,KAAM,kBAAkB,CAC7C,OAASC,SAAS,CAAEC,UAAU,KAAQ,gBAAgB,CACtD,OAASC,MAAM,KAAQ,YAAY,CACnC,MAAO,CAAAC,MAAM,KAAM,qBAAqB,CAAC,OAAAC,GAAA,IAAAC,IAAA,CAAAC,IAAA,IAAAC,KAAA,CAAAC,QAAA,IAAAC,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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}